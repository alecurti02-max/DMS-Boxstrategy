<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMS Analytics Pro - v1.2</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg: #0b0e14; --card: #151921; --text: #e9ecef;
            --accent: #1d8cf8; --missile: #ffdf00; --direct: #fd5d93; --success: #00f2c3;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .header-flex { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid #2b3548; }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        .config-row { display: flex; gap: 20px; align-items: center; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; flex-wrap: wrap; }

        .dashboard { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 8px; overflow: hidden; }
        th { background: #1d2331; padding: 12px; text-align: left; font-size: 0.8em; color: #888; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #2b3548; font-weight: bold; font-size: 0.95em; }
        
        .row-direct { background: rgba(253, 93, 147, 0.12) !important; border-left: 4px solid var(--direct); }
        .row-virtual-leader { border-left: 4px solid var(--success); background: rgba(0, 242, 195, 0.05); }

        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .panel { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid #2b3548; }
        
        input, button { background: #0b0e14; border: 1px solid #3d4b64; color: white; padding: 10px; border-radius: 4px; }
        button { background: var(--accent); cursor: pointer; font-weight: bold; border: none; }
        .btn-connect { background: var(--success); color: black; }
        
        .status-tag { padding: 4px 8px; border-radius: 4px; font-size: 0.7em; font-weight: 800; }
        .in-pit { background: #ff4757; color: white; }
        .on-track { background: var(--success); color: black; }
        .virtual-time { color: var(--success); font-family: 'Courier New', monospace; }
    </style>
</head>
<body>

<div class="header-flex">
    <div class="top-row">
        <h2 style="margin:0;">DMS ANALYTICS <span style="font-size:0.5em; color:var(--accent)">V1.2</span></h2>
        <div id="connectionStatus" style="color:gray;">‚óã DISCONNECTED</div>
    </div>
    
    <div class="config-row">
        <div style="flex:1; display:flex; gap:10px; align-items:center;">
            <strong>üîó APEX URL:</strong>
            <input type="text" id="apexUrlInput" placeholder="https://live.apex-timing.com/..." style="flex:1;">
            <button class="btn-connect" onclick="connectToApex()">CONNECT</button>
        </div>
        <div style="display:flex; gap:10px; align-items:center; border-left: 1px solid #3d4b64; padding-left: 20px;">
            <strong>‚è±Ô∏è PIT OBBL. (SEC):</strong>
            <input type="number" id="minPitInput" value="1800" style="width:80px; text-align:center;" onchange="updateVirtualLogic()">
        </div>
    </div>
</div>

<div class="dashboard">
    <div class="main-table">
        <table>
            <thead>
                <tr>
                    <th>Pos. Real</th>
                    <th>Team</th>
                    <th>Pit Fatti</th>
                    <th>Tempo ai Box</th>
                    <th>Last Lap</th>
                    <th>Gap Virtu</th>
                    <th>Status</th>
                    <th>POS. VIRTUAL</th>
                </tr>
            </thead>
            <tbody id="telemetryBody"></tbody>
        </table>
    </div>

    <div class="sidebar">
        <div class="panel">
            <strong>AVVERSARI DIRETTI</strong><br><br>
            <div style="display:flex; gap:5px;">
                <input type="text" id="directInput" placeholder="Num. Team..." style="flex:1">
                <button onclick="addDirect()">ADD</button>
            </div>
            <div id="directList" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>
        </div>

        <div class="panel">
            <strong>FOCUS GAP (VIRTUAL)</strong>
            <div id="targetInfo" style="font-size: 1.8em; color: var(--success); text-align: center; margin: 10px 0;">--.---</div>
            <div id="targetTeam" style="text-align:center; font-size:0.8em; color:#888;">Nessun avversario selezionato</div>
        </div>
        
        <button onclick="window.location.href='index.html'" style="background:#2c2c44; width:100%;">‚Ü© TORNA AI BOX</button>
    </div>
</div>

<script>
    // Configurazione Firebase (Stessa della v9.19)
    const firebaseConfig = { 
        apiKey: "AIzaSyDKhKjjrVb1EtNosBsO-5dYICBfLU8Feco", 
        authDomain: "gestione-cambi-kart---dms.firebaseapp.com", 
        databaseURL: "https://gestione-cambi-kart---dms-default-rtdb.europe-west1.firebasedatabase.app", 
        projectId: "gestione-cambi-kart---dms"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let directCompetitors = JSON.parse(localStorage.getItem('directCompetitors')) || [];
    let minPitTime = 1800;
    let apexInterval = null;
    const bipAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    let lastInPit = new Set();

    // Carica URL salvato
    document.getElementById('apexUrlInput').value = localStorage.getItem('lastApexUrl') || '';

    function connectToApex() {
        const url = document.getElementById('apexUrlInput').value.trim();
        if(!url) return alert("Inserisci un link Apex valido");
        
        localStorage.setItem('lastApexUrl', url);
        document.getElementById('connectionStatus').innerText = "‚óè LIVE CONNECTED";
        document.getElementById('connectionStatus').style.color = "var(--success)";

        if(apexInterval) clearInterval(apexInterval);
        apexInterval = setInterval(updateTelemetry, 3000);
        updateTelemetry();
    }

    function updateVirtualLogic() {
        minPitTime = parseInt(document.getElementById('minPitInput').value);
        if(apexInterval) updateTelemetry();
    }

    function addDirect() {
        const val = document.getElementById('directInput').value.trim();
        if(val && !directCompetitors.includes(val)) {
            directCompetitors.push(val);
            localStorage.setItem('directCompetitors', JSON.stringify(directCompetitors));
            renderDirects();
            if(apexInterval) updateTelemetry();
        }
    }

    function removeDirect(num) {
        directCompetitors = directCompetitors.filter(d => d !== num);
        localStorage.setItem('directCompetitors', JSON.stringify(directCompetitors));
        renderDirects();
        if(apexInterval) updateTelemetry();
    }

    function renderDirects() {
        const container = document.getElementById('directList');
        container.innerHTML = directCompetitors.map(d => 
            `<span class="status-tag in-pit" style="cursor:pointer" onclick="removeDirect('${d}')">#${d} ‚úï</span>`
        ).join('');
    }

    async function updateTelemetry() {
        // NOTA TECNICA: In gara, useremo un proxy CORS per leggere l'URL incollato
        // Per ora manteniamo la simulazione logica per vedere i calcoli
        let rawData = [
            { num: "1", team: "Leader", raceTime: 5000, pitCount: 2, pitTime: 1200, last: 45.1, status: "TRACK", rating: "normale" },
            { num: "10", team: "DMS Racing", raceTime: 5050, pitCount: 3, pitTime: 1800, last: 45.4, status: "TRACK", rating: "prestazione" },
            { num: "5", team: "Avversario", raceTime: 4900, pitCount: 1, pitTime: 600, last: 44.9, status: "TRACK", rating: "missile" }
        ];

        let virtualData = rawData.map(t => ({
            ...t,
            virtualTotal: t.raceTime + Math.max(0, minPitTime - t.pitTime)
        })).sort((a, b) => a.virtualTotal - b.virtualTotal);

        renderTable(virtualData);
    }

    function renderTable(data) {
        const body = document.getElementById('telemetryBody');
        body.innerHTML = "";
        const leaderVirtualTime = data[0].virtualTotal;

        data.forEach((row, index) => {
            const isDirect = directCompetitors.includes(row.num);
            const virtualGap = (row.virtualTotal - leaderVirtualTime).toFixed(3);
            
            if(row.rating === 'missile' && row.status === 'PIT' && !lastInPit.has(row.num)) {
                bipAudio.play(); lastInPit.add(row.num);
            } else if(row.status === 'TRACK') { lastInPit.delete(row.num); }

            const tr = document.createElement('tr');
            if(isDirect) tr.className = 'row-direct';
            if(index === 0) tr.classList.add('row-virtual-leader');

            tr.innerHTML = `
                <td style="color:#888">#${index + 1}</td>
                <td>${row.team} <small>(#${row.num})</small></td>
                <td style="text-align:center">${row.pitCount}</td>
                <td style="color:${row.pitTime >= minPitTime ? 'var(--success)' : '#ff8d72'}">
                    ${Math.floor(row.pitTime/60)}m ${row.pitTime%60}s
                </td>
                <td>${row.last.toFixed(3)}</td>
                <td class="virtual-time">${index === 0 ? 'LEADER' : '+' + virtualGap + 's'}</td>
                <td><span class="status-tag ${row.status==='PIT'?'in-pit':'on-track'}">${row.status}</span></td>
                <td style="text-align:center; font-size:1.2em; color:var(--accent)">P${index + 1}</td>
            `;
            body.appendChild(tr);

            if(isDirect && index > 0) {
                document.getElementById('targetInfo').innerText = "+" + virtualGap + "s";
                document.getElementById('targetTeam').innerText = "Distacco virtuale: " + row.team;
            }
        });
    }

    renderDirects();
</script>

</body>
</html>
