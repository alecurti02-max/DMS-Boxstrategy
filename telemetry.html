<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMS Analytics Pro - v1.1</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg: #0b0e14; --card: #151921; --text: #e9ecef;
            --accent: #1d8cf8; --missile: #ffdf00; --direct: #fd5d93; --success: #00f2c3;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        /* HEADER E CONFIG */
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid #2b3548; }
        .config-box { display: flex; align-items: center; gap: 10px; font-size: 0.9em; }

        .dashboard { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 8px; overflow: hidden; }
        th { background: #1d2331; padding: 12px; text-align: left; font-size: 0.8em; color: #888; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #2b3548; font-weight: bold; font-size: 0.95em; }
        
        .row-direct { background: rgba(253, 93, 147, 0.12) !important; border-left: 4px solid var(--direct); }
        .row-virtual-leader { border-left: 4px solid var(--success); background: rgba(0, 242, 195, 0.05); }

        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .panel { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid #2b3548; }
        
        input, button, select { background: #0b0e14; border: 1px solid #3d4b64; color: white; padding: 10px; border-radius: 4px; }
        button { background: var(--accent); cursor: pointer; font-weight: bold; border: none; }
        button:hover { opacity: 0.8; }
        
        .status-tag { padding: 4px 8px; border-radius: 4px; font-size: 0.7em; font-weight: 800; }
        .in-pit { background: #ff4757; color: white; }
        .on-track { background: var(--success); color: black; }

        .virtual-time { color: var(--success); font-family: 'Courier New', monospace; }
    </style>
</head>
<body>

<div class="header-flex">
    <div>
        <h2 style="margin:0;">DMS ANALYTICS <span style="font-size:0.5em; color:var(--accent)">VIRTUAL STANDING</span></h2>
    </div>
    <div class="config-box">
        <span>‚è±Ô∏è PIT OBBLIGATORIO (SEC):</span>
        <input type="number" id="minPitInput" value="1800" style="width:80px; text-align:center;" onchange="updateVirtualLogic()">
        <div id="connectionStatus" style="color:var(--success); margin-left:15px;">‚óè LIVE</div>
    </div>
</div>

<div class="dashboard">
    <div class="main-table">
        <table>
            <thead>
                <tr>
                    <th>Pos. Real</th>
                    <th>Team</th>
                    <th>Pit Fatti</th>
                    <th>Tempo ai Box</th>
                    <th>Last Lap</th>
                    <th>Gap Virtu</th>
                    <th>Status</th>
                    <th>POS. VIRTUAL</th>
                </tr>
            </thead>
            <tbody id="telemetryBody"></tbody>
        </table>
    </div>

    <div class="sidebar">
        <div class="panel">
            <strong>AVVERSARI DIRETTI</strong><br><br>
            <div style="display:flex; gap:5px;">
                <input type="text" id="directInput" placeholder="Num. Team..." style="flex:1">
                <button onclick="addDirect()">ADD</button>
            </div>
            <div id="directList" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>
        </div>

        <div class="panel">
            <strong>FOCUS GAP (VIRTUAL)</strong>
            <div id="targetInfo" style="font-size: 1.8em; color: var(--success); text-align: center; margin: 10px 0;">--.---</div>
            <div id="targetTeam" style="text-align:center; font-size:0.8em; color:#888;">Nessun avversario selezionato</div>
        </div>
        
        <div class="panel" style="font-size:0.8em; color:#888;">
            <em>La <strong>Posizione Virtuale</strong> calcola la classifica come se tutti avessero gi√† completato il tempo di sosta obbligatorio.</em>
        </div>
    </div>
</div>

<script>
    // Inizializzazione Firebase
    const firebaseConfig = { 
        apiKey: "AIzaSyDKhKjjrVb1EtNosBsO-5dYICBfLU8Feco", 
        authDomain: "gestione-cambi-kart---dms.firebaseapp.com", 
        databaseURL: "https://gestione-cambi-kart---dms-default-rtdb.europe-west1.firebasedatabase.app", 
        projectId: "gestione-cambi-kart---dms"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let directCompetitors = JSON.parse(localStorage.getItem('directCompetitors')) || [];
    let minPitTime = 1800; // Default 30 min in secondi
    const bipAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    let lastInPit = new Set();

    function updateVirtualLogic() {
        minPitTime = parseInt(document.getElementById('minPitInput').value);
        updateTelemetry();
    }

    function addDirect() {
        const val = document.getElementById('directInput').value.trim();
        if(val && !directCompetitors.includes(val)) {
            directCompetitors.push(val);
            localStorage.setItem('directCompetitors', JSON.stringify(directCompetitors));
            renderDirects();
            updateTelemetry();
        }
    }

    function removeDirect(num) {
        directCompetitors = directCompetitors.filter(d => d !== num);
        localStorage.setItem('directCompetitors', JSON.stringify(directCompetitors));
        renderDirects();
        updateTelemetry();
    }

    function renderDirects() {
        const container = document.getElementById('directList');
        container.innerHTML = directCompetitors.map(d => 
            `<span class="status-tag in-pit" style="cursor:pointer" onclick="removeDirect('${d}')">#${d} ‚úï</span>`
        ).join('');
    }

    async function updateTelemetry() {
        // SIMULAZIONE DATI APEX (In produzione qui va il fetch reale)
        // Immaginiamo che Apex ci dia: Tempo totale di gara, numero pit e tempo totale in sosta
        let rawData = [
            { num: "1", team: "Team Leader", raceTime: 5000, pitCount: 2, pitTime: 1200, last: 45.1, status: "TRACK", rating: "normale" },
            { num: "10", team: "DMS Racing", raceTime: 5050, pitCount: 3, pitTime: 1800, last: 45.4, status: "TRACK", rating: "prestazione" },
            { num: "5", team: "Avversario", raceTime: 4900, pitCount: 1, pitTime: 600, last: 44.9, status: "TRACK", rating: "missile" }
        ];

        // LOGICA CLASSIFICA VIRTUALE
        // Tempo Virtuale = Tempo Reale - Tempo Pit Effettuato + (Tempo Pit Mancante)
        // Pi√π semplicemente: Tempo Reale + (MinPitObbligatorio - TempoPitEffettuato)
        
        let virtualData = rawData.map(t => {
            let missingPit = Math.max(0, minPitTime - t.pitTime);
            return {
                ...t,
                virtualTotal: t.raceTime + missingPit
            };
        });

        // Ordiniamo per tempo virtuale (chi ha il tempo pi√π basso √® primo)
        virtualData.sort((a, b) => a.virtualTotal - b.virtualTotal);

        renderTable(virtualData);
    }

    function renderTable(data) {
        const body = document.getElementById('telemetryBody');
        body.innerHTML = "";
        
        const leaderVirtualTime = data[0].virtualTotal;

        data.forEach((row, index) => {
            const isDirect = directCompetitors.includes(row.num);
            const virtualGap = (row.virtualTotal - leaderVirtualTime).toFixed(3);
            
            // Gestione Bip Missili nel box
            if(row.rating === 'missile' && row.status === 'PIT' && !lastInPit.has(row.num)) {
                bipAudio.play(); lastInPit.add(row.num);
            } else if(row.status === 'TRACK') { lastInPit.delete(row.num); }

            const tr = document.createElement('tr');
            if(isDirect) tr.className = 'row-direct';
            if(index === 0) tr.classList.add('row-virtual-leader');

            tr.innerHTML = `
                <td style="color:#888">#${index + 1 + (index==0?' üèÜ':'')}</td>
                <td>${row.team} <small>(#${row.num})</small></td>
                <td style="text-align:center">${row.pitCount}</td>
                <td style="color:${row.pitTime >= minPitTime ? 'var(--success)' : '#ff8d72'}">
                    ${Math.floor(row.pitTime/60)}m ${row.pitTime%60}s
                </td>
                <td>${row.last.toFixed(3)}</td>
                <td class="virtual-time">${index === 0 ? 'LEADER' : '+' + virtualGap + 's'}</td>
                <td><span class="status-tag ${row.status==='PIT'?'in-pit':'on-track'}">${row.status}</span></td>
                <td style="text-align:center; font-size:1.2em; color:var(--accent)">P${index + 1}</td>
            `;
            body.appendChild(tr);

            // Aggiorna Focus Sidebar se √® un diretto
            if(isDirect && index > 0) {
                document.getElementById('targetInfo').innerText = "+" + virtualGap + "s";
                document.getElementById('targetTeam').innerText = "Gap virtuale di " + row.team + " dal leader";
            }
        });
    }

    renderDirects();
    setInterval(updateTelemetry, 3000);
    updateTelemetry();
</script>

</body>
</html>
