<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMS Analytics Pro - v1.6 R-One Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0b0e14; --card: #151921; --text: #e9ecef;
            --accent: #1d8cf8; --success: #00f2c3; --direct: #fd5d93; --warning: #ff4757;
            --ek1: #2ecc71; --ek2: #ffffff; --ek3: #e74c3c;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; overflow: hidden; }
        
        .header-flex { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid #2b3548; }
        .main-container { display: grid; grid-template-columns: 1fr 180px 380px; gap: 15px; height: calc(100vh - 220px); }
        
        .panel { background: var(--card); border-radius: 8px; border: 1px solid #2b3548; display: flex; flex-direction: column; overflow: hidden; }
        .scroll-area { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th { background: #1d2331; padding: 12px; text-align: left; position: sticky; top: 0; color: #888; z-index: 10; border-bottom: 2px solid #2b3548; }
        td { padding: 10px; border-bottom: 1px solid #2b3548; font-weight: bold; }
        
        .row-our-team { background: rgba(0, 242, 195, 0.15) !important; outline: 1px solid var(--success); }
        .row-direct { background: rgba(253, 93, 147, 0.1); border-left: 4px solid var(--direct); }
        
        .cat-badge { padding: 3px 8px; border-radius: 4px; font-size: 0.75em; color: #000; font-weight: 900; }
        .cat-EK1 { background: var(--ek1); }
        .cat-EK2 { background: var(--ek2); }
        .cat-EK3 { background: var(--ek3); }

        .filter-select { background: #1d8cf8; color: white; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        .chart-container { flex: 1; background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid #2b3548; min-height: 250px; }
        
        button { cursor: pointer; font-weight: bold; border: none; border-radius: 4px; padding: 8px 15px; transition: 0.2s; }
        .btn-nav { background: #2c2c44; width: 100%; padding: 12px; color: white; margin-top: 10px; }
        input, select { background: #0b0e14; border: 1px solid #3d4b64; color: white; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="header-flex">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h2 style="margin:0;">DMS ANALYTICS <span style="font-size:0.5em; color:var(--accent)">V1.6 R-ONE</span></h2>
            <div id="ourTeamDisplay" style="color:var(--success); font-weight:bold; font-size:0.9em; margin-top:5px;">NOSTRO TEAM: --</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <strong>FILTRA CLASSIFICA:</strong>
            <select id="catSelector" class="filter-select" onchange="updateTelemetry()">
                <option value="ALL">ASSOLUTA (Tutte)</option>
                <option value="EK1">SOLO EK1 (Verdi)</option>
                <option value="EK2">SOLO EK2 (Bianchi)</option>
                <option value="EK3">SOLO EK3 (Rossi)</option>
            </select>
            <button onclick="exportTelemetryCSV()" style="background:#2c2c44; color:white; border: 1px solid #3d4b64;">EXPORT CSV</button>
            <button onclick="resetGara()" style="background:var(--warning); color:white;">RESET</button>
        </div>
    </div>
    <div style="display:flex; gap:15px; align-items:center;">
        <strong>ðŸ”— APEX FEED URL:</strong>
        <input type="text" id="apexUrlInput" placeholder="URL .json..." style="flex:1;">
        <button onclick="connectToApex()" style="background:var(--success); color:black;">CONNECT LIVE</button>
        <strong>PIT OBBL (SEC):</strong>
        <input type="number" id="minPitInput" value="2280" style="width:90px;" onchange="updateTelemetry()">
    </div>
</div>

<div class="main-container">
    <div class="panel">
        <div class="scroll-area">
            <table>
                <thead>
                    <tr><th>POS</th><th>CAT</th><th>TEAM</th><th>PIT</th><th>TEMPO BOX</th><th>LAST</th><th>GAP VIRTUAL</th></tr>
                </thead>
                <tbody id="mainBody"></tbody>
            </table>
        </div>
    </div>

    <div class="panel">
        <div style="padding:10px; background:#1d2331; font-weight:bold; text-align:center; font-size:0.8em; border-bottom: 1px solid #3d4b64;">RANK VIRTUALE</div>
        <div class="scroll-area" id="virtualRankList" style="padding:5px;"></div>
    </div>

    <div style="display:flex; flex-direction:column; gap:15px;">
        <div class="panel" style="padding:10px;">
            <strong>AVVERSARI DIRETTI</strong>
            <div style="display:flex; gap:5px; margin-top:8px;">
                <input type="text" id="directInput" placeholder="Num. Kart..." style="flex:1">
                <button onclick="addDirect()" style="background:var(--direct); color:white;">ADD</button>
            </div>
            <div id="directList" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;"></div>
        </div>

        <div class="chart-container">
            <canvas id="gapChart"></canvas>
        </div>
        
        <button onclick="window.location.href='index.html'" class="btn-nav">â†© TORNA AI BOX</button>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDKhKjjrVb1EtNosBsO-5dYICBfLU8Feco", authDomain: "gestione-cambi-kart---dms.firebaseapp.com", databaseURL: "https://gestione-cambi-kart---dms-default-rtdb.europe-west1.firebasedatabase.app", projectId: "gestione-cambi-kart---dms" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let ourKartNum = ""; 
    let directCompetitors = JSON.parse(localStorage.getItem('directCompetitors')) || [];
    let telemetryHistory = [];
    let apexInterval = null;

    db.ref('raceState/ourKartId').on('value', snap => {
        ourKartNum = snap.val() || "";
        document.getElementById('ourTeamDisplay').innerText = "NOSTRO TEAM: #" + ourKartNum;
    });

    function parsePitTimeToSeconds(timeStr) {
        if (!timeStr) return 0;
        if (typeof timeStr === 'number') return timeStr;
        if (!timeStr.includes(':')) return parseInt(timeStr) || 0;
        const parts = timeStr.split(':');
        return (parseInt(parts[0]) * 60) + parseInt(parts[1]);
    }

    const ctx = document.getElementById('gapChart').getContext('2d');
    const gapChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { 
                y: { grid: { color: '#2b3548' }, ticks: { color: '#fff' } },
                x: { display: false }
            },
            plugins: { legend: { position: 'bottom', labels: { color: '#fff', boxWidth: 10, font: { size: 10 } } } }
        }
    });

    async function updateTelemetry() {
        const minPit = parseInt(document.getElementById('minPitInput').value);
        const selectedCat = document.getElementById('catSelector').value;
        
        // DATI SIMULATI (Sostituiti dal feed Apex in gara)
        let rawData = [
            { num: "1", team: "NAC TEAM", cat: "EK1", raceTime: 36000, pitCount: 14, pitTime: "38:01", last: "1:06.7", status: "TRACK" },
            { num: "23", team: "KRT", cat: "EK1", raceTime: 36015, pitCount: 14, pitTime: "38:23", last: "1:04.8", status: "TRACK" },
            { num: "22", team: "DMS RACING TEAM", cat: "EK1", raceTime: 36020, pitCount: 12, pitTime: "38:02", last: "1:03.2", status: "TRACK" },
            { num: "49", team: "SPARKART RACING", cat: "EK2", raceTime: 36050, pitCount: 15, pitTime: "38:05", last: "1:03.3", status: "TRACK" },
            { num: "4", team: "GOATS RT RED", cat: "EK3", raceTime: 36080, pitCount: 12, pitTime: "38:03", last: "1:03.8", status: "TRACK" }
        ];

        // 1. Processamento e Calcolo Virtuale
        let processed = rawData.map(t => {
            const pitSec = parsePitTimeToSeconds(t.pitTime);
            return {
                ...t,
                pitSeconds: pitSec,
                vTotal: t.raceTime + Math.max(0, minPit - pitSec)
            };
        }).sort((a,b) => a.vTotal - b.vTotal);

        // 2. Applicazione Filtro Categoria
        if (selectedCat !== 'ALL') {
            processed = processed.filter(t => t.cat === selectedCat);
        }

        renderUI(processed);
        updateChart(processed);
        telemetryHistory.push({ts: new Date().toLocaleTimeString(), data: processed});
    }

    function renderUI(data) {
        const mainBody = document.getElementById('mainBody');
        const virtRank = document.getElementById('virtualRankList');
        mainBody.innerHTML = ""; virtRank.innerHTML = "";
        
        if(data.length === 0) return;
        const vLeaderTime = data[0].vTotal;

        data.forEach((row, idx) => {
            const isUs = row.num === ourKartNum;
            const isDirect = directCompetitors.includes(row.num);
            const vGap = (row.vTotal - vLeaderTime).toFixed(1);
            
            mainBody.innerHTML += `
                <tr class="${isUs ? 'row-our-team' : (isDirect ? 'row-direct' : '')}">
                    <td>${idx+1}</td>
                    <td><span class="cat-badge cat-${row.cat}">${row.cat}</span></td>
                    <td>${row.team} <small>#${row.num}</small></td>
                    <td>${row.pitCount}</td>
                    <td>${row.pitTime}</td>
                    <td>${row.last}</td>
                    <td style="color:var(--success)">+${vGap}s</td>
                </tr>`;
            
            virtRank.innerHTML += `
                <div style="background:#1d2331; border-radius:4px; margin:4px; padding:8px; text-align:center; border: 1px solid ${isUs ? 'var(--success)' : '#3d4b64'}; color:${isUs ? 'var(--success)' : 'white'}">
                    <span style="font-size:0.7em; color:#888">P${idx+1}</span><br>#${row.num}
                </div>`;
        });
    }

    function updateChart(data) {
        const ourData = data.find(t => t.num === ourKartNum);
        if(!ourData) return;

        const now = new Date().toLocaleTimeString([], {minute:'2-digit', second:'2-digit'});
        gapChart.data.labels.push(now);
        if(gapChart.data.labels.length > 30) gapChart.data.labels.shift();

        const toTrack = [ourKartNum, ...directCompetitors];
        toTrack.forEach(num => {
            const team = data.find(t => t.num === num);
            if(!team) return;
            let dataset = gapChart.data.datasets.find(d => d.label === `Kart #${num}`);
            if(!dataset) {
                const color = (num === ourKartNum) ? '#00f2c3' : '#' + Math.floor(Math.random()*16777215).toString(16);
                dataset = { label: `Kart #${num}`, data: [], borderColor: color, borderWidth: (num === ourKartNum ? 3 : 2), tension: 0.3, pointRadius: 0 };
                gapChart.data.datasets.push(dataset);
            }
            dataset.data.push(team.vTotal - ourData.vTotal);
            if(dataset.data.length > 30) dataset.data.shift();
        });
        gapChart.update('none');
    }

    function addDirect() {
        const val = document.getElementById('directInput').value.trim();
        if(val && !directCompetitors.includes(val) && val !== ourKartNum) {
            directCompetitors.push(val);
            localStorage.setItem('directCompetitors', JSON.stringify(directCompetitors));
            renderDirects();
        }
        document.getElementById('directInput').value = "";
    }

    function renderDirects() {
        document.getElementById('directList').innerHTML = directCompetitors.map(d => 
            `<span style="background:var(--direct); padding:4px 8px; border-radius:4px; font-size:0.8em; cursor:pointer;" onclick="removeDirect('${d}')">#${d} âœ•</span>`).join('');
    }

    function removeDirect(num) {
        directCompetitors = directCompetitors.filter(d => d !== num);
        localStorage.setItem('directCompetitors', JSON.stringify(directCompetitors));
        gapChart.data.datasets = gapChart.data.datasets.filter(d => d.label !== `Kart #${num}`);
        gapChart.update();
        renderDirects();
    }

    function connectToApex() {
        const url = document.getElementById('apexUrlInput').value.trim();
        if(!url) return;
        if(apexInterval) clearInterval(apexInterval);
        apexInterval = setInterval(updateTelemetry, 3000);
        updateTelemetry();
    }

    function resetGara() { if(confirm("Resettare i dati?")) { telemetryHistory = []; gapChart.data.labels = []; gapChart.data.datasets = []; gapChart.update(); } }
    
    renderDirects();
    updateTelemetry();
</script>
</body>
</html>
