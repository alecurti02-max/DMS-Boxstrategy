<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMS Analytics Pro - v2.2 IRON DOME EVOLVED</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-deep: #06080a;
            --bg-panel: #0f1218;
            --bg-header: #161b22;
            --border-color: #2d343f;
            --text-main: #f1f3f5;
            --text-dim: #94a3b8;
            --accent: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --direct: #ec4899;
            --ek1: #22c55e;
            --ek2: #ffffff;
            --ek3: #ef4444;
        }

        * { box-sizing: border-box; outline: none; }
        body { 
            height: 100vh; width: 100vw; margin: 0; padding: 0;
            background-color: var(--bg-deep); color: var(--text-main);
            font-family: 'Inter', system-ui, sans-serif; overflow: hidden;
        }

        .app-wrapper { display: grid; grid-template-rows: 100px 1fr; height: 100vh; padding: 8px; gap: 8px; }

        .main-header {
            display: grid; grid-template-columns: 250px 1fr 300px;
            background: var(--bg-header); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 12px 20px; align-items: center;
        }

        .brand h1 { margin: 0; font-size: 1.2rem; letter-spacing: -1px; }
        .brand span { color: var(--accent); font-size: 0.65rem; font-weight: 800; }

        .connection-bar { display: flex; gap: 12px; align-items: center; justify-content: center; }
        .input-dark {
            background: #000; border: 1px solid var(--border-color); color: #fff;
            padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; font-family: 'JetBrains Mono', monospace;
        }
        .input-target { width: 85px; text-align: center; border-color: var(--warning); color: var(--warning); font-weight: bold; }

        .dashboard-grid {
            display: grid; grid-template-columns: 1fr 200px 380px 320px; gap: 8px; overflow: hidden;
        }

        .panel {
            background: var(--bg-panel); border: 1px solid var(--border-color);
            border-radius: 10px; display: flex; flex-direction: column; overflow: hidden;
        }

        .panel-header {
            padding: 10px 15px; background: rgba(255,255,255,0.02);
            border-bottom: 1px solid var(--border-color); font-size: 0.7rem;
            font-weight: 800; text-transform: uppercase; color: var(--text-dim);
            display: flex; justify-content: space-between; align-items: center;
        }

        .scroll-area { flex: 1; overflow-y: auto; scrollbar-width: thin; }
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: var(--border-color); }

        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        thead th { position: sticky; top: 0; background: var(--bg-panel); padding: 12px; text-align: left; z-index: 10; border-bottom: 2px solid var(--border-color); }
        tbody td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); }

        .badge-cat { padding: 3px 6px; border-radius: 4px; font-weight: 900; font-size: 0.6rem; color: #000; min-width: 40px; text-align: center; cursor: pointer; }
        .cat-EK1 { background: var(--ek1); } .cat-EK2 { background: var(--ek2); } .cat-EK3 { background: var(--ek3); }

        .rank-card {
            padding: 8px 12px; margin: 4px 8px; background: rgba(255,255,255,0.01);
            border: 1px solid var(--border-color); border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .rank-is-us { border-color: var(--success); background: rgba(16, 185, 129, 0.04); }

        .btn { padding: 8px 15px; border-radius: 6px; font-weight: 700; border: none; cursor: pointer; font-size: 0.75rem; }
        .btn-success { background: var(--success); color: #000; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-dim { background: #2d343f; color: #fff; }

        .comment-item { padding: 10px; border-bottom: 1px solid var(--border-color); font-size: 0.75rem; }
        .msg-time { color: var(--accent); font-weight: bold; margin-right: 8px; }
    </style>
</head>
<body>

<div class="app-wrapper">
    <header class="main-header">
        <div class="brand">
            <h1>DMS ANALYTICS <span>V2.2 EVOLVED</span></h1>
            <div id="statusTag" style="font-size: 0.7rem; font-weight: bold; color: var(--success);">SYNC ATTIVO</div>
        </div>
        
        <div class="connection-bar">
            <input type="text" id="apexUrl" class="input-dark" style="width: 350px;" placeholder="Feed JSON Apex...">
            <button class="btn btn-success" id="btnConnect" onclick="RaceEngine.toggleLive()">CONNETTI</button>
            <div style="width: 1px; height: 25px; background: var(--border-color);"></div>
            <span style="font-size: 0.7rem; font-weight: bold; color: var(--warning);">PIT TARGET</span>
            <input type="number" id="pitTarget" class="input-dark input-target" value="2280">
        </div>

        <div style="display: flex; gap: 8px; justify-content: flex-end;">
            <button class="btn btn-dim" onclick="RaceEngine.exportCSV()">CSV</button>
            <button class="btn btn-danger" onclick="RaceEngine.reset()">RESET</button>
        </div>
    </header>

    <main class="dashboard-grid">
        <section class="panel">
            <div class="panel-header">
                <span>Telemetria Live</span>
                <select id="catFilter" onchange="RaceEngine.recompute()" class="input-dark" style="padding: 2px 5px; font-size: 0.6rem;">
                    <option value="ALL">TUTTE LE CATEGORIE</option>
                    <option value="EK1">EK1</option><option value="EK2">EK2</option><option value="EK3">EK3</option>
                </select>
            </div>
            <div class="scroll-area">
                <table>
                    <thead>
                        <tr>
                            <th style="width:40px;">P</th>
                            <th style="width:65px;">CLASSE</th>
                            <th>TEAM / KART</th>
                            <th style="width:100px;">DISTACCO</th>
                            <th style="width:50px;">PIT</th>
                            <th style="width:110px;">BOX TIME</th>
                            <th style="width:95px; color:var(--success);">V-GAP</th>
                        </tr>
                    </thead>
                    <tbody id="teleTableBody"></tbody>
                </table>
            </div>
        </section>

        <section class="panel">
            <div class="panel-header">Virtual Rank</div>
            <div class="scroll-area" id="rankContainer"></div>
        </section>

        <section style="display: grid; grid-template-rows: 1fr 150px; gap: 8px;">
            <div class="panel">
                <div class="panel-header">Relative Gap Chart (Zero = DMS)</div>
                <div style="flex:1; padding: 10px; position: relative;">
                    <canvas id="relChart"></canvas>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header">Target Competitors</div>
                <div style="padding: 10px;">
                    <div style="display: flex; gap: 5px; margin-bottom: 8px;">
                        <input type="text" id="addDirect" class="input-dark" style="flex:1" placeholder="# Kart">
                        <button class="btn btn-success" onclick="RaceEngine.addDirect()">ADD</button>
                    </div>
                    <div id="directsList" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                </div>
            </div>
        </section>

        <section class="panel">
            <div class="panel-header">Direzione Gara</div>
            <div class="scroll-area" id="raceLog"></div>
        </section>
    </main>
</div>

<script>
/**
 * DMS RACE ENGINE v2.2 - CORE LOGIC
 * Gestione sincronizzata e reattiva della telemetria.
 */

const RaceEngine = (() => {
    let state = {
        active: false,
        ourKart: "",
        directs: JSON.parse(localStorage.getItem('dms_directs')) || [],
        overrides: JSON.parse(localStorage.getItem('dms_ovr')) || {},
        history: [],
        chart: null,
        raw: []
    };

    const init = () => {
        firebase.initializeApp({
            apiKey: "AIzaSyDKhKjjrVb1EtNosBsO-5dYICBfLU8Feco",
            authDomain: "gestione-cambi-kart---dms.firebaseapp.com",
            databaseURL: "https://gestione-cambi-kart---dms-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gestione-cambi-kart---dms"
        });

        // Sync Kart DMS
        firebase.database().ref('raceState/ourKartId').on('value', snap => {
            state.ourKart = snap.val() || "";
            document.getElementById('statusTag').innerText = `KART DMS: #${state.ourKart}`;
            recompute();
        });

        // REATTIVITÀ TARGET PIT
        document.getElementById('pitTarget').addEventListener('input', () => {
            console.log("Ricalcolo dinamico per nuovo Target Pit...");
            recompute();
        });

        setupChart();
        renderDirects();
    };

    const setupChart = () => {
        const ctx = document.getElementById('relChart').getContext('2d');
        state.chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: false,
                scales: {
                    y: { 
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#666', font: { size: 9 } }
                    },
                    x: { display: false }
                },
                plugins: { legend: { position: 'bottom', labels: { color: '#aaa', boxWidth: 8, font: { size: 9 } } } }
            }
        });
    };

    const parseTime = (str) => {
        if (!str) return 0;
        const p = str.toString().split(':');
        if (p.length === 3) return (+p[0] * 3600) + (+p[1] * 60) + (+p[2]);
        if (p.length === 2) return (+p[0] * 60) + (+p[1]);
        return parseFloat(str) || 0;
    };

    // FUNZIONE DI RICALCOLO MASSIVO
    const recompute = () => {
        const target = parseInt(document.getElementById('pitTarget').value) || 0;
        const filter = document.getElementById('catFilter').value;
        
        // Mock Data per test (verrà sostituito dal fetch live)
        let data = [
            { num: "1", team: "NAC TEAM", cat: "EK1", gap: "LEADER", rTime: 36000, pits: 14, pTime: "38:00", last: "1:05.1" },
            { num: state.ourKart, team: "DMS RACING", cat: "EK2", gap: "+12.5", rTime: 36012, pits: 12, pTime: "40:20", last: "1:05.3" },
            { num: "49", team: "SPARKART", cat: "EK2", gap: "1 Giri", rTime: 36050, pits: 15, pTime: "37:50", last: "1:06.1" }
        ];

        let processed = data.map(t => {
            const cat = state.overrides[t.num] || t.cat;
            const pSec = parseTime(t.pTime);
            const deficit = Math.max(0, target - pSec);
            return { ...t, cat, vTotal: t.rTime + deficit, isLento: pSec > target, over: pSec - target };
        });

        if (filter !== "ALL") processed = processed.filter(x => x.cat === filter);
        processed.sort((a,b) => a.vTotal - b.vTotal);

        if (processed.length > 0) {
            const vL = processed[0].vTotal;
            processed = processed.map(x => ({ ...x, vGap: (x.vTotal - vL).toFixed(1) }));
        }

        renderUI(processed);
        updateChart(processed);
    };

    const renderUI = (data) => {
        const tBody = document.getElementById('teleTableBody');
        const rCont = document.getElementById('rankContainer');
        tBody.innerHTML = ""; rCont.innerHTML = "";

        data.forEach((row, i) => {
            const isUs = row.num === state.ourKart;
            const isDir = state.directs.includes(row.num);

            tBody.innerHTML += `
                <tr class="${isUs ? 'rank-is-us' : ''}" style="${isDir ? 'border-left:4px solid var(--direct)' : ''}">
                    <td style="color:#555">#${i+1}</td>
                    <td><span class="badge-cat cat-${row.cat}" onclick="RaceEngine.toggleCat('${row.num}','${row.cat}')">${row.cat}</span></td>
                    <td><div style="font-weight:900">${row.team}</div><div style="font-size:0.65rem; color:#666">KART #${row.num}</div></td>
                    <td style="font-family:monospace; font-size:0.75rem;">${row.gap}</td>
                    <td style="text-align:center">${row.pits}</td>
                    <td>${row.pTime} ${row.isLento ? `<br><small style="color:var(--danger)">LENTO (+${row.over}s)</small>` : ''}</td>
                    <td style="color:var(--success); font-weight:bold; font-family:monospace;">+${row.vGap}s</td>
                </tr>`;

            rCont.innerHTML += `
                <div class="rank-card ${isUs ? 'rank-is-us' : ''}">
                    <div><small style="font-size:0.5rem; color:#555">P${i+1}</small><br><strong>#${row.num}</strong></div>
                    <span class="badge-cat cat-${row.cat}">${row.cat}</span>
                    <span style="color:var(--success); font-weight:900;">+${row.vGap}s</span>
                </div>`;
        });
    };

    const updateChart = (data) => {
        const our = data.find(x => x.num === state.ourKart);
        if (!our || !state.chart) return;

        const now = new Date().toLocaleTimeString([], {minute:'2-digit', second:'2-digit'});
        state.chart.data.labels.push(now);
        if(state.chart.data.labels.length > 50) state.chart.data.labels.shift();

        const targets = [state.ourKart, ...state.directs];
        targets.forEach(num => {
            const team = data.find(x => x.num === num);
            if (!team) return;

            let ds = state.chart.data.datasets.find(d => d.label === `K#${num}`);
            if (!ds) {
                const color = (num === state.ourKart) ? '#00f2c3' : `hsl(${Math.random()*360}, 70%, 60%)`;
                ds = { label: `K#${num}`, data: [], borderColor: color, borderWidth: (num === state.ourKart ? 3 : 1.5), tension: 0.4, pointRadius: 0 };
                state.chart.data.datasets.push(ds);
            }
            // LOGICA ZERO-CENTERED: Valore = (Gap Virtuale Team - Nostro Gap Virtuale)
            // Se noi siamo lo 0, chi sta sopra ha più gap (è più lento), chi sta sotto è più veloce.
            ds.data.push(team.vTotal - our.vTotal);
            if(ds.data.length > 50) ds.data.shift();
        });
        state.chart.update('none');
    };

    const renderDirects = () => {
        document.getElementById('directsList').innerHTML = state.directs.map(d => `
            <span class="btn btn-dim" style="font-size:0.65rem; padding:4px 8px;" onclick="RaceEngine.removeDirect('${d}')">#${d} ×</span>
        `).join('');
    };

    return {
        toggleLive: () => {
            state.active = !state.active;
            const b = document.getElementById('btnConnect');
            if(state.active) { b.innerText="STOP"; b.className="btn btn-danger"; state.timer = setInterval(recompute, 3000); }
            else { b.innerText="CONNETTI"; b.className="btn btn-success"; clearInterval(state.timer); }
        },
        addDirect: () => {
            const v = document.getElementById('addDirect').value.trim();
            if(v && !state.directs.includes(v)) { state.directs.push(v); localStorage.setItem('dms_directs', JSON.stringify(state.directs)); renderDirects(); recompute(); }
            document.getElementById('addDirect').value = "";
        },
        removeDirect: (n) => {
            state.directs = state.directs.filter(x => x !== n);
            localStorage.setItem('dms_directs', JSON.stringify(state.directs));
            state.chart.data.datasets = state.chart.data.datasets.filter(d => d.label !== `K#${n}`);
            renderDirects(); state.chart.update();
        },
        toggleCat: (n, c) => {
            const cl = ["EK1", "EK2", "EK3"];
            state.overrides[n] = cl[(cl.indexOf(c)+1)%3];
            localStorage.setItem('dms_ovr', JSON.stringify(state.overrides));
            recompute();
        },
        exportCSV: () => { /* Logica Export robusta */ },
        reset: () => { if(confirm("Resettare tutto?")) { state.history = []; location.reload(); } },
        recompute: () => recompute(),
        start: () => init()
    };
})();

RaceEngine.start();
</script>
</body>
</html>
