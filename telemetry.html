<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMS Analytics Pro - v2.1 Live</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0b0e14; --card: #151921; --text: #e9ecef;
            --accent: #1d8cf8; --success: #00f2c3; --direct: #fd5d93; --warning: #ff4757;
            --ek1: #2ecc71; --ek2: #ffffff; --ek3: #e74c3c;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 12px; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .header-flex { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid #2b3548; }
        .main-container { display: grid; grid-template-columns: 1fr 200px 400px; gap: 12px; height: calc(100vh - 210px); }
        
        .panel { background: var(--card); border-radius: 8px; border: 1px solid #2b3548; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { padding: 8px 12px; background: #1d2331; font-weight: bold; font-size: 0.75em; border-bottom: 1px solid #3d4b64; color: #888; text-transform: uppercase; }
        
        .scroll-area { flex: 1; overflow-y: auto; scrollbar-width: thin; }
        
        /* Tabella Rinforzata */
        table { width: 100%; border-collapse: collapse; font-size: 0.82em; table-layout: fixed; }
        th { background: #1d2331; padding: 10px; text-align: left; position: sticky; top: 0; color: #888; z-index: 10; border-bottom: 2px solid #2b3548; font-size: 0.75em; }
        td { padding: 8px 10px; border-bottom: 1px solid #2b3548; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .row-our-team { background: rgba(0, 242, 195, 0.12) !important; color: var(--success); }
        .row-direct { background: rgba(253, 93, 147, 0.08) !important; border-left: 4px solid var(--direct); }
        
        /* Badges e UI Elements */
        .cat-badge { padding: 3px 8px; border-radius: 4px; font-size: 0.65em; color: #000; font-weight: 900; cursor: pointer; display: inline-block; min-width: 45px; text-align: center; }
        .cat-EK1 { background: var(--ek1); }
        .cat-EK2 { background: var(--ek2); }
        .cat-EK3 { background: var(--ek3); }

        /* Rank Laterale Stretto */
        .rank-card-mini { 
            background: #1d2331; border-radius: 4px; margin-bottom: 4px; padding: 6px 10px; 
            border: 1px solid #3d4b64; display: flex; align-items: center; justify-content: space-between;
        }
        .rank-card-mini.is-us { border-color: var(--success); background: rgba(0,242,195,0.05); }
        .rank-info { display: flex; flex-direction: column; }
        .rank-pos { font-size: 0.6em; color: #556a89; font-weight: 800; }
        .rank-num { font-size: 1.1em; font-weight: 900; }

        /* Controls */
        input, select { background: #0b0e14; border: 1px solid #3d4b64; color: white; padding: 8px; border-radius: 4px; font-size: 0.9em; }
        .filter-select { background: var(--accent); font-weight: bold; border: none; }
        button { cursor: pointer; font-weight: bold; border: none; border-radius: 4px; padding: 8px 15px; }
        
        /* Alert Styles */
        .pit-alert { color: var(--warning); font-size: 0.85em; display: block; font-weight: bold; }
        .pit-ok { color: #556a89; font-size: 0.8em; }
        .gap-real { color: #556a89; font-size: 0.85em; font-family: monospace; }
        .chart-container { flex: 1; background: var(--card); padding: 10px; border-radius: 8px; border: 1px solid #2b3548; position: relative; }
    </style>
</head>
<body>

<div class="header-flex">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center; gap:15px;">
            <h2 style="margin:0; letter-spacing: 1px;">DMS ANALYTICS <span style="color:var(--accent); font-size:0.6em;">v2.1 LIVE</span></h2>
            <div id="ourTeamDisplay" style="color:var(--success); font-weight:bold; background: rgba(0,242,195,0.1); padding: 4px 12px; border-radius: 4px; border: 1px solid var(--success);">In attesa...</div>
        </div>
        <div style="display:flex; gap:8px;">
            <select id="catSelector" class="filter-select" onchange="processData(lastRawData)">
                <option value="ALL">ASSOLUTA</option>
                <option value="EK1">EK1 (VERDE)</option>
                <option value="EK2">EK2 (BIANCO)</option>
                <option value="EK3">EK3 (ROSSO)</option>
            </select>
            <button onclick="exportTelemetryCSV()" style="background:#2c2c44; color:white;">EXPORT</button>
            <button onclick="resetGara()" style="background:var(--warning); color:white;">RESET</button>
        </div>
    </div>
    <div style="display:flex; gap:15px; align-items:center; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px;">
        <input type="text" id="apexUrlInput" placeholder="Incolla URL JSON qui..." style="flex:1;">
        <button onclick="connectToApex()" style="background:var(--success); color:black;">CONNETTI</button>
        <span style="font-size:0.8em; font-weight:bold;">PIT TARGET (Sec):</span>
        <input type="number" id="minPitInput" value="2280" style="width:90px; text-align:center;" onchange="processData(lastRawData)">
    </div>
</div>

<div class="main-container">
    <div class="panel">
        <div class="scroll-area">
            <table>
                <thead>
                    <tr>
                        <th style="width:45px;">POS</th>
                        <th style="width:70px;">CLASSE</th>
                        <th style="width:160px;">TEAM</th>
                        <th style="width:100px;">DISTACCO</th>
                        <th style="width:50px;">PIT</th>
                        <th style="width:95px;">DA SCONTARE</th>
                        <th style="width:85px;">ULTIMO</th>
                        <th style="width:95px; color:var(--success)">GAP VIRTUAL</th>
                    </tr>
                </thead>
                <tbody id="mainBody"></tbody>
            </table>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">Rank Virtuale</div>
        <div class="scroll-area" id="virtualRankList" style="padding:8px;"></div>
    </div>

    <div style="display:flex; flex-direction:column; gap:12px;">
        <div class="panel" style="padding:12px;">
            <strong style="font-size:0.75em; color:#888;">MARCATURA AVVERSARI</strong>
            <div style="display:flex; gap:5px; margin-top:8px;">
                <input type="text" id="directInput" placeholder="# Kart" style="flex:1">
                <button onclick="addDirect()" style="background:var(--direct); color:white; padding:5px 10px;">ADD</button>
            </div>
            <div id="directList" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;"></div>
        </div>

        <div class="chart-container">
            <canvas id="gapChart"></canvas>
        </div>
        
        <button onclick="window.location.href='index.html'" style="background:#2c2c44; color:white; padding:12px; border: 1px solid #3d4b64;">↩ TORNA AI BOX</button>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDKhKjjrVb1EtNosBsO-5dYICBfLU8Feco", authDomain: "gestione-cambi-kart---dms.firebaseapp.com", databaseURL: "https://gestione-cambi-kart---dms-default-rtdb.europe-west1.firebasedatabase.app", projectId: "gestione-cambi-kart---dms" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let ourKartNum = ""; 
    let directCompetitors = JSON.parse(localStorage.getItem('directCompetitors')) || [];
    let catOverrides = JSON.parse(localStorage.getItem('catOverrides')) || {}; 
    let telemetryHistory = [];
    let chartInstance = null;
    let apexInterval = null;
    let lastRawData = []; // Store per ricalcoli rapidi

    db.ref('raceState/ourKartId').on('value', snap => {
        ourKartNum = snap.val() || "";
        document.getElementById('ourTeamDisplay').innerText = "KART #" + ourKartNum;
        if(lastRawData.length > 0) processData(lastRawData);
    });

    // Helper conversioni
    function parseToSeconds(timeStr) {
        if (!timeStr || typeof timeStr === 'number') return timeStr || 0;
        const p = timeStr.toString().split(':');
        if (p.length === 3) return (+p[0]) * 3600 + (+p[1]) * 60 + (+p[2]);
        if (p.length === 2) return (+p[0]) * 60 + (+p[1]);
        return parseFloat(timeStr) || 0;
    }

    function formatTime(sec) {
        if(sec < 0) return "-" + formatTime(-sec);
        const m = Math.floor(sec / 60);
        const s = Math.floor(sec % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    function toggleCat(kartNum, current) {
        const order = ["EK1", "EK2", "EK3"];
        catOverrides[kartNum] = order[(order.indexOf(current) + 1) % order.length];
        localStorage.setItem('catOverrides', JSON.stringify(catOverrides));
        if(lastRawData.length > 0) processData(lastRawData);
    }

    // --- LOGICA FETCH E CONNESSIONE ---
    function connectToApex() {
        let url = document.getElementById('apexUrlInput').value.trim();
        
        // Se non c'è URL, usa la Demo Mode
        if(!url) { 
            loadDemoData(); 
            return; 
        }

        // Aggiungi Proxy se serve
        if (!url.includes('cors-anywhere.herokuapp.com') && !url.startsWith('http://localhost')) {
            url = 'https://cors-anywhere.herokuapp.com/' + url;
        }

        if(apexInterval) clearInterval(apexInterval);
        
        document.getElementById('ourTeamDisplay').innerText = "CONNESSIONE...";
        fetchAndProcess(url);
        apexInterval = setInterval(() => fetchAndProcess(url), 5000);
    }

    async function fetchAndProcess(url) {
        try {
            const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            const data = await response.json();
            
            // Trova dove sono i dati (Apex varia struttura)
            let teamsSource = data.data || data.vehicles || data.teams || data;
            if (!Array.isArray(teamsSource) && typeof teamsSource === 'object') {
                teamsSource = Object.values(teamsSource);
            }

            // Mappatura generica
            lastRawData = teamsSource.map(t => ({
                num: t.no || t.number || t.kart_number || (t.kart ? t.kart : "0"),
                team: t.name || t.team_name || "Team " + (t.no || ""),
                cat: t.cat || t.category || "EK1",
                distacco: t.gap || t.diff || "0.0",
                raceTime: parseToSeconds(t.total_time || t.time_elapsed || 0),
                pitCount: t.pit || t.pitstops || 0,
                pitTime: parseToSeconds(t.pit_time || t.total_pit_time || 0),
                last: t.last_lap || t.last_time || "0.0"
            }));

            processData(lastRawData);

        } catch (e) {
            console.error("Errore Fetch:", e);
            document.getElementById('ourTeamDisplay').innerText = "ERRORE CORS (Vedi Console)";
        }
    }

    function loadDemoData() {
        alert("Nessun URL inserito. Carico dati DEMO.");
        lastRawData = [
            { num: "1", team: "NAC TEAM", cat: "EK1", distacco: "LEADER", raceTime: 36000, pitCount: 14, pitTime: 2000, last: "1:02.79" },
            { num: "22", team: "DMS RACING", cat: "EK1", distacco: "15.420", raceTime: 36015, pitCount: 12, pitTime: 2400, last: "1:02.85" },
            { num: "49", team: "SPARKART", cat: "EK2", distacco: "1 Giri", raceTime: 36060, pitCount: 15, pitTime: 2200, last: "1:03.11" }
        ];
        processData(lastRawData);
    }

    // --- LOGICA VIRTUAL GAP (DEFICIT CALC) ---
    function processData(rawData) {
        if(!rawData || rawData.length === 0) return;
        const targetPit = parseInt(document.getElementById('minPitInput').value) || 2280;
        const filter = document.getElementById('catSelector').value;

        let processed = rawData.map(t => {
            const cat = catOverrides[t.num] || t.cat;
            const pitSec = t.pitTime;
            
            // Deficit: Quanto DEVO ancora stare ai box? Se < 0, è 0 (tempo perso).
            const deficit = Math.max(0, targetPit - pitSec);
            
            // Virtual Total: Tempo Gara + Tempo che manca da scontare
            const vTotal = t.raceTime + deficit;

            return {
                ...t,
                cat,
                pitSec,
                vTotal,
                deficit,
                isWasted: pitSec > targetPit, // Ha superato il tempo limite
                wastedTime: Math.max(0, pitSec - targetPit)
            };
        });

        if (filter !== 'ALL') processed = processed.filter(t => t.cat === filter);
        processed.sort((a,b) => a.vTotal - b.vTotal);
        
        if (processed.length > 0) {
            const vLeader = processed[0].vTotal;
            processed = processed.map(t => ({ ...t, vGap: (t.vTotal - vLeader).toFixed(1) }));
        }

        renderUI(processed);
        updateChart(processed);
        
        // Salva per export
        if(processed.length > 0) {
            telemetryHistory.push({ ts: new Date().toLocaleTimeString(), data: processed });
            if(telemetryHistory.length > 200) telemetryHistory.shift();
        }
    }

    function renderUI(data) {
        const body = document.getElementById('mainBody');
        const list = document.getElementById('virtualRankList');
        body.innerHTML = ""; list.innerHTML = "";

        data.forEach((row, idx) => {
            const isUs = row.num === ourKartNum;
            const isDirect = directCompetitors.includes(row.num);
            
            // Colonna DA SCONTARE (Logica Colori)
            let daScontareHtml = "";
            if (row.isWasted) {
                // Ha perso tempo oltre il limite
                daScontareHtml = `<span class="pit-alert">PERSO +${formatTime(row.wastedTime)}</span>`;
            } else if (row.deficit > 0) {
                // Deve ancora scontare
                daScontareHtml = `<span class="pit-ok" style="font-weight:bold;">-${formatTime(row.deficit)}</span>`;
            } else {
                daScontareHtml = `<span style="color:#00f2c3; font-weight:bold;">COMPLETATO</span>`;
            }

            body.innerHTML += `
                <tr class="${isUs ? 'row-our-team' : (isDirect ? 'row-direct' : '')}">
                    <td style="color:#555">#${idx+1}</td>
                    <td><span class="cat-badge cat-${row.cat}" onclick="toggleCat('${row.num}', '${row.cat}')">${row.cat}</span></td>
                    <td><div style="font-size:1em">${row.team}</div><div style="font-size:0.7em; color:#888">KART #${row.num}</div></td>
                    <td class="gap-real">${row.distacco}</td>
                    <td style="text-align:center;">${row.pitCount}</td>
                    <td style="text-align:center;">${daScontareHtml}</td>
                    <td style="font-family:monospace">${row.last}</td>
                    <td style="color:var(--success); font-family:monospace; font-size:1.1em; font-weight:bold;">+${row.vGap}s</td>
                </tr>`;
            
            list.innerHTML += `
                <div class="rank-card-mini ${isUs ? 'is-us' : ''}">
                    <div class="rank-info">
                        <span class="rank-pos">POS VIRT. ${idx+1}</span>
                        <span class="rank-num" style="color:${isUs ? 'var(--success)' : 'white'}">#${row.num}</span>
                    </div>
                    <span class="cat-badge cat-${row.cat}" style="min-width:35px; font-size:0.55em; cursor:default;">${row.cat}</span>
                </div>`;
        });
        
        if(ourKartNum) {
           document.getElementById('ourTeamDisplay').innerText = "KART #" + ourKartNum;
        }
    }

    function initChart() {
        const ctx = document.getElementById('gapChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: false,
                scales: { 
                    y: { grid: { color: 'rgba(255,255,255,0.02)' }, ticks: { color: '#555', font: { size: 9 } } },
                    x: { display: false }
                },
                plugins: { legend: { position: 'bottom', labels: { color: '#888', boxWidth: 8, font: { size: 10 } } } }
            }
        });
    }

    function updateChart(data) {
        const ourData = data.find(t => t.num === ourKartNum);
        if(!ourData || !chartInstance) return;

        const now = new Date().toLocaleTimeString([], {minute:'2-digit', second:'2-digit'});
        chartInstance.data.labels.push(now);
        if(chartInstance.data.labels.length > 40) chartInstance.data.labels.shift();

        const targets = [ourKartNum, ...directCompetitors];
        targets.forEach(num => {
            const team = data.find(t => t.num === num);
            if(!team) return;

            let ds = chartInstance.data.datasets.find(d => d.label === `K#${num}`);
            if(!ds) {
                const color = (num === ourKartNum) ? '#00f2c3' : `hsl(${Math.random() * 360}, 70%, 60%)`;
                ds = { label: `K#${num}`, data: [], borderColor: color, borderWidth: (num === ourKartNum ? 3 : 2), tension: 0.3, pointRadius: 0 };
                chartInstance.data.datasets.push(ds);
            }
            ds.data.push(team.vTotal - ourData.vTotal);
            if(ds.data.length > 40) ds.data.shift();
        });
        chartInstance.update('none');
    }

    function addDirect() {
        const v = document.getElementById('directInput').value.trim();
        if(v && !directCompetitors.includes(v) && v !== ourKartNum) {
            directCompetitors.push(v);
            localStorage.setItem('directCompetitors', JSON.stringify(directCompetitors));
            renderDirects();
            processData(lastRawData);
        }
        document.getElementById('directInput').value = "";
    }

    function renderDirects() {
        document.getElementById('directList').innerHTML = directCompetitors.map(d => 
            `<span style="background:var(--direct); padding:4px 10px; border-radius:4px; font-size:0.75em; cursor:pointer;" onclick="removeDirect('${d}')">#${d} ✕</span>`).join('');
    }

    function removeDirect(num) {
        directCompetitors = directCompetitors.filter(d => d !== num);
        localStorage.setItem('directCompetitors', JSON.stringify(directCompetitors));
        if(chartInstance) {
            chartInstance.data.datasets = chartInstance.data.datasets.filter(d => d.label !== `K#${num}`);
            chartInstance.update();
        }
        renderDirects();
    }

    function exportTelemetryCSV() {
        if(telemetryHistory.length === 0) return;
        let csv = "Timestamp;Pos;Cat;Kart;Team;GapReal;GapVirt;DaScontare\n";
        telemetryHistory.forEach(s => {
            s.data.forEach((t, i) => {
                csv += `${s.ts};${i+1};${t.cat};${t.num};${t.team};${t.distacco};${t.vGap};${t.deficit}\n`;
            });
        });
        const b = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `DMS_Report_${Date.now()}.csv`; a.click();
    }

    function resetGara() {
        if(confirm("Resettare storico e grafico?")) {
            telemetryHistory = [];
            if(chartInstance) { chartInstance.data.labels = []; chartInstance.data.datasets = []; chartInstance.update(); }
            processData(lastRawData);
        }
    }

    window.onload = () => { initChart(); renderDirects(); };
</script>
</body>
</html>
