<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMS Analytics Pro - v2.9.1 RECOVERY</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-deep: #040506; --bg-panel: #0b0e14; --bg-header: #12161d;
            --border: #262c35; --text: #f1f3f5; --dim: #768390;
            --accent: #3b82f6; --success: #00f2c3; --warning: #f5ae0b;
            --danger: #ff4d4d; --direct: #ec4899;
            --ek1: #00e676; --ek2: #ffffff; --ek3: #ff5252;
        }

        * { box-sizing: border-box; outline: none; }
        body { 
            height: 100vh; width: 100vw; margin: 0; padding: 0;
            background-color: var(--bg-deep); color: var(--text);
            font-family: 'Inter', sans-serif; overflow: hidden;
        }

        .app-wrapper { display: grid; grid-template-rows: 70px 1fr; height: 100vh; padding: 5px; gap: 5px; }

        .main-header {
            display: grid; grid-template-columns: 180px 1fr 400px;
            background: var(--bg-header); border: 1px solid var(--border);
            border-radius: 8px; padding: 0 15px; align-items: center;
        }
        
        .input-dark {
            background: #000; border: 1px solid var(--border); color: #fff;
            padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-family: monospace;
        }

        .dashboard-grid {
            display: grid; 
            grid-template-columns: 1fr 280px; 
            grid-template-rows: 1fr 200px;
            gap: 5px; overflow: hidden;
        }

        .telemetry-panel { grid-row: 1 / 3; }

        .panel {
            background: var(--bg-panel); border: 1px solid var(--border);
            border-radius: 8px; display: flex; flex-direction: column; overflow: hidden;
        }

        .panel-header {
            padding: 5px 10px; background: rgba(255,255,255,0.02);
            border-bottom: 1px solid var(--border); font-size: 0.55rem;
            font-weight: 900; text-transform: uppercase; color: var(--dim);
            display: flex; justify-content: space-between; align-items: center;
        }

        .scroll-area { flex: 1; overflow-y: auto; scrollbar-width: thin; }

        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; table-layout: fixed; }
        thead th { 
            position: sticky; top: 0; background: var(--bg-panel); padding: 8px; 
            text-align: left; z-index: 50; border-bottom: 2px solid var(--border);
            color: var(--dim); font-size: 0.52rem;
        }
        tbody td { padding: 4px 8px; border-bottom: 1px solid rgba(255,255,255,0.01); white-space: nowrap; }

        .row-us { background: rgba(0, 242, 195, 0.08) !important; border-left: 4px solid var(--success); }
        .row-direct { border-left: 4px solid var(--direct) !important; background: rgba(236, 72, 153, 0.03); }
        
        .badge-cat { padding: 2px 4px; border-radius: 3px; font-weight: 900; font-size: 0.5rem; color: #000; min-width: 32px; text-align: center; }
        .cat-EK1 { background: var(--ek1); } .cat-EK2 { background: var(--ek2); } .cat-EK3 { background: var(--ek3); }

        .v-gap-box { font-family: monospace; font-weight: 800; color: var(--success); }
        .timer-box { font-family: monospace; font-weight: 700; color: var(--warning); }
        .timer-over { color: var(--danger); animation: critical-blink 1s infinite; }
        @keyframes critical-blink { 50% { opacity: 0.4; } }

        .btn { padding: 5px 12px; border-radius: 4px; font-weight: 800; border: none; cursor: pointer; font-size: 0.65rem; }
        .btn-success { background: var(--success); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--dim); }

        .rank-item {
            padding: 3px 8px; margin-bottom: 2px; background: rgba(255,255,255,0.02);
            border: 1px solid var(--border); border-radius: 4px;
            display: flex; justify-content: space-between; align-items: center; font-size: 0.62rem;
        }
    </style>
</head>
<body>

<div class="app-wrapper">
    <header class="main-header">
        <div class="brand">
            <h1 style="margin:0; font-size:0.8rem; color:var(--accent)">DMS STRATEGIC v2.9.1</h1>
            <div id="conn" style="font-size:0.5rem; color:var(--success)">LINK RECOVERED</div>
        </div>
        
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="apex" class="input-dark" style="width: 150px;" placeholder="Feed Apex URL...">
            <button class="btn btn-success" onclick="Run.toggle()">START</button>
            <div style="width: 1px; height: 15px; background: var(--border);"></div>
            <span style="font-size: 0.5rem; font-weight: 900; color: var(--warning);">PIT TARGET</span>
            <input type="number" id="target" class="input-dark" style="width:60px" value="2280">
        </div>

        <div style="display: flex; gap: 8px; justify-content: flex-end; align-items: center;">
            <button class="btn btn-outline" onclick="window.open('https://gestione-cambi-kart---dms.firebaseapp.com', '_blank')">PAGINA BOX</button>
            <button class="btn btn-outline" onclick="Run.csv()">CSV</button>
            <button class="btn btn-outline" style="color:var(--danger)" onclick="Run.reset()">RESET</button>
        </div>
    </header>

    <main class="dashboard-grid">
        <section class="panel telemetry-panel">
            <div class="panel-header">Real-Time Classification</div>
            <div class="scroll-area">
                <table id="table">
                    <thead>
                        <tr>
                            <th style="width: 30px;">P</th>
                            <th style="width: 40px;">CAT</th>
                            <th style="width: 40px;">#</th>
                            <th style="width: 150px;">TEAM</th>
                            <th style="width: 80px; color:var(--accent)">DIST. APEX</th>
                            <th style="width: 35px;">PIT</th>
                            <th style="width: 70px;">BOX T.</th>
                            <th style="width: 85px; color:var(--warning)">REMAINING</th>
                            <th style="width: 70px;">LAST</th>
                            <th style="width: 80px; color:var(--success)">V-GAP</th>
                        </tr>
                    </thead>
                    <tbody id="rows"></tbody>
                </table>
            </div>
        </section>

        <section class="panel">
            <div class="panel-header">Relative Strategy Gap</div>
            <div style="flex:1; padding:5px;"><canvas id="chart"></canvas></div>
        </section>

        <section style="display: grid; grid-template-rows: 1fr 80px; gap: 5px;">
            <div class="panel">
                <div class="panel-header">Virtual Rank</div>
                <div class="scroll-area" style="padding:5px;" id="rank"></div>
            </div>
            <div class="panel">
                <div class="panel-header">Tracking</div>
                <div style="padding:5px;">
                    <input type="text" id="addK" class="input-dark" style="width:100%;" placeholder="+ Kart #">
                    <div id="dirBox" style="display:flex; flex-wrap:wrap; gap:2px; margin-top:3px;"></div>
                </div>
            </div>
        </section>
    </main>
</div>

<script>
const Run = (() => {
    let s = { active: false, our: "22", directs: [], ovr: {}, chart: null, timer: null, data: [] };

    const init = () => {
        firebase.initializeApp({
            apiKey: "AIzaSyDKhKjjrVb1EtNosBsO-5dYICBfLU8Feco",
            authDomain: "gestione-cambi-kart---dms.firebaseapp.com",
            databaseURL: "https://gestione-cambi-kart---dms-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gestione-cambi-kart---dms"
        });
        firebase.database().ref('raceState/ourKartId').on('value', snap => { s.our = snap.val() || "22"; calc(); });
        setupChart(); calc();
    };

    const setupChart = () => {
        const ctx = document.getElementById('chart').getContext('2d');
        s.chart = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [] }, options: {
            responsive: true, maintainAspectRatio: false, animation: false,
            scales: { x: { display: false }, y: { ticks: { size: 8 } } },
            plugins: { legend: { display:false } }
        }});
    };

    const toS = (v) => {
        if(!v) return 0;
        const p = v.split(':');
        return p.length === 3 ? (+p[0]*3600)+(+p[1]*60)+(+p[2]) : (p.length === 2 ? (+p[0]*60)+(+p[1]) : parseFloat(v) || 0);
    };

    const fmt = (v) => {
        const ag = Math.abs(v);
        return `${v<0?'-':''}${Math.floor(ag/60)}:${Math.floor(ag%60).toString().padStart(2,'0')}`;
    };

    const calc = () => {
        const target = parseInt(document.getElementById('target').value) || 0;
        let raw = [
            { n: "1", t: "NAC TEAM", c: "EK1", d: "LEADER", rT: 36000, p: 14, pT: "38:00", l: "1:02.7" },
            { n: s.our, t: "DMS RACING", c: "EK2", d: "+12.8", rT: 36012, p: 12, pT: "40:20", l: "1:02.8" },
            { n: "49", t: "SPARKART", c: "EK2", d: "1 Lap", rT: 36050, p: 15, pT: "37:50", l: "1:03.1" }
        ];

        let proc = raw.map(k => {
            const cat = s.ovr[k.n] || k.c;
            const ps = toS(k.pT);
            return { ...k, cat, vT: k.rT + Math.max(0, target - ps), rem: target - ps };
        });

        proc.sort((a,b) => a.vT - b.vT);
        if(proc.length > 0) {
            const l = proc[0].vT;
            proc = proc.map(k => ({ ...k, vG: (k.vT - l).toFixed(1) }));
        }

        s.data = proc;
        render(proc);
        updateChart(proc);
    };

    const render = (data) => {
        const b = document.getElementById('rows');
        const r = document.getElementById('rank');
        b.innerHTML = ""; r.innerHTML = "";
        data.forEach((k, i) => {
            const isU = k.n === s.our;
            const tr = document.createElement('tr');
            if(isU) tr.className = "row-us";
            tr.innerHTML = `<td>${i+1}</td><td><span class="badge-cat cat-${k.cat}">${k.cat}</span></td>
                <td>#${k.n}</td><td style="font-weight:700">${k.t}</td><td style="color:var(--accent)">${k.d}</td>
                <td align="center">${k.p}</td><td>${k.pT}</td><td class="timer-box ${k.rem<0?'timer-over':''}">${fmt(k.rem)}</td>
                <td>${k.l}</td><td class="v-gap-box">+${k.vG}s</td>`;
            b.appendChild(tr);

            r.innerHTML += `<div class="rank-item" style="${isU?'border:1px solid var(--success)':''}">
                <span><b>#${k.n}</b> <small>${k.cat}</small></span><span class="v-gap-box">+${k.vG}s</span>
            </div>`;
        });
    };

    const updateChart = (data) => {
        const our = data.find(k => k.n === s.our);
        if(!our || !s.chart) return;
        const time = new Date().toLocaleTimeString([], {minute:'2-digit', second:'2-digit'});
        s.chart.data.labels.push(time);
        if(s.chart.data.labels.length > 30) s.chart.data.labels.shift();
        [s.our, ...s.directs].forEach(num => {
            const t = data.find(k => k.n === num); if(!t) return;
            let ds = s.chart.data.datasets.find(d => d.label === `#${num}`);
            if(!ds) {
                ds = { label: `#${num}`, data: [], borderColor: num===s.our?'#00f2c3':'#ec4899', borderWidth: 2, pointRadius: 0 };
                s.chart.data.datasets.push(ds);
            }
            ds.data.push(t.vT - our.vT);
            if(ds.data.length > 30) ds.data.shift();
        });
        s.chart.update();
    };

    return {
        toggle: () => { s.active = !s.active; s.active ? s.timer = setInterval(calc, 3000) : clearInterval(s.timer); },
        csv: () => { 
            let c = "POS;KART;TEAM;VGAP\n" + s.data.map((k,i)=>`${i+1};${k.n};${k.t};${k.vG}`).join('\n');
            const blob = new Blob([c], {type:'text/csv'}); window.open(URL.createObjectURL(blob));
        },
        reset: () => { localStorage.clear(); location.reload(); },
        start: () => init()
    };
})();
Run.start();
</script>
</body>
</html>
