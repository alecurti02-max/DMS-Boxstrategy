<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DMS STRATEGY V3 - ULTIMATE TITAN SYSTEM</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* DARK THEME (DEFAULT) */
            --bg: #0a0c10; --card: #141820; --header: #1c222d; --border: #2d3545;
            --text: #eceff4; --text-dim: #9ba3b1; --accent: #1d8cf8; --success: #00f2c3;
            --warning: #ff4757; --direct: #fd5d93;
            /* RATING COLORS */
            --missile: #ffdf00; --prestazione: #00f2c3; --normale: #34495e; --lento: #ff8d72; --osceno: #fd5d93;
            /* CATEGORY COLORS */
            --ek1: #2ecc71; --ek2: #ffffff; --ek3: #e74c3c;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.light-theme {
            --bg: #f0f3f5; --card: #ffffff; --header: #e1e7eb; --border: #cbd5e0;
            --text: #2d3748; --text-dim: #718096;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        body { 
            background-color: var(--bg); color: var(--text); margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            transition: background 0.3s ease;
        }

        /* --- HEADER & CONTROLS --- */
        .top-bar {
            height: 65px; background: var(--header); border-bottom: 2px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            z-index: 100;
        }

        .pit-target-box {
            background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 6px;
            border: 1px solid var(--accent); display: flex; flex-direction: column;
        }

        .pit-target-box label { font-size: 10px; text-transform: uppercase; color: var(--accent); font-weight: 800; }
        .pit-target-box input { 
            background: transparent; border: none; color: white; font-weight: bold; 
            font-size: 16px; width: 60px; outline: none; text-align: center;
        }

        /* --- MAIN LAYOUT GRID --- */
        .main-grid {
            flex: 1; display: grid; grid-template-rows: 1.2fr 1fr; /* Telemetria sopra, Gestione sotto */
            gap: 10px; padding: 10px; overflow: hidden;
        }

        .panel { 
            background: var(--card); border: 1px solid var(--border); border-radius: 8px;
            display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .panel-header {
            padding: 10px 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- TELEMETRIA SECTION --- */
        .telemetry-split { display: grid; grid-template-columns: 1fr 400px; height: 100%; }
        
        .table-wrapper { flex: 1; overflow: auto; border-right: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
        th { 
            background: var(--header); color: var(--text-dim); position: sticky; top: 0;
            padding: 12px 8px; text-align: left; font-size: 10px; text-transform: uppercase;
            border-bottom: 2px solid var(--border); z-index: 20;
        }
        td { padding: 10px 8px; border-bottom: 1px solid var(--border); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .col-pos { width: 40px; } .col-cat { width: 60px; } .col-kart { width: 60px; }
        .col-vgap { width: 90px; color: var(--success); font-weight: 800; font-size: 14px; }
        
        .row-us { background: rgba(29, 140, 248, 0.15) !important; color: var(--accent); }
        .row-pitting { animation: pulse-pit 2s infinite; background: rgba(255, 71, 87, 0.1) !important; }
        @keyframes pulse-pit { 50% { background: rgba(255, 71, 87, 0.2) !important; } }

        .badge-cat { padding: 3px 6px; border-radius: 4px; font-size: 10px; font-weight: 900; color: #000; }
        .ek1 { background: var(--ek1); } .ek2 { background: var(--ek2); } .ek3 { background: var(--ek3); }

        /* --- CHART SECTION --- */
        .chart-container { padding: 10px; display: flex; flex-direction: column; height: 100%; background: #080a0e; }

        /* --- MANAGEMENT SECTION --- */
        .management-split { display: grid; grid-template-columns: 1fr 350px 250px; height: 100%; }

        .lanes-container { 
            display: flex; gap: 12px; overflow-x: auto; padding: 10px;
            background: rgba(0,0,0,0.15); scrollbar-width: thin;
        }

        .lane {
            min-width: 280px; background: var(--bg); border-radius: 8px;
            border-top: 4px solid var(--accent); display: flex; flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: var(--transition);
        }

        .lane-head { 
            padding: 10px; font-weight: 800; font-size: 12px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02);
        }

        .kart-list { flex: 1; padding: 8px; min-height: 50px; }
        
        /* KART CARD */
        .kart-card {
            background: var(--card); border: 1px solid var(--border); border-radius: 6px;
            padding: 12px; margin-bottom: 8px; cursor: grab; position: relative;
            transition: var(--transition);
        }
        .kart-card:active { cursor: grabbing; transform: scale(0.97); }
        .kart-card.selected { border: 2px solid var(--accent); box-shadow: 0 0 10px var(--accent); }

        .rating-dots { display: flex; gap: 5px; margin-top: 10px; }
        .dot { 
            width: 14px; height: 14px; border-radius: 3px; cursor: pointer; 
            border: 1px solid rgba(255,255,255,0.1); transition: transform 0.2s;
        }
        .dot:hover { transform: scale(1.3); }

        /* --- CONTROL PANEL --- */
        .control-panel { border-left: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .btn { 
            padding: 12px; border: none; border-radius: 6px; font-weight: 800; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition);
        }
        .btn-success { background: var(--success); color: #000; }
        .btn-accent { background: var(--accent); color: #fff; }
        .btn-danger { background: var(--warning); color: #fff; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn:hover { filter: brightness(1.2); }

        input, select { 
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            padding: 10px; border-radius: 6px; width: 100%; outline: none;
        }

        /* --- LOG PANEL --- */
        .log-panel { border-left: 1px solid var(--border); padding: 10px; display: flex; flex-direction: column; }
        #action-logs { 
            flex: 1; overflow-y: auto; font-size: 11px; font-family: 'Consolas', monospace;
            display: flex; flex-direction: column-reverse; gap: 5px; color: var(--text-dim);
        }
        .log-line { border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 3px; }

        /* --- BOTTOM DATABASE --- */
        .db-drawer {
            height: 250px; background: var(--card); border-top: 2px solid var(--border);
            overflow-y: auto; padding: 20px; transition: height 0.3s ease;
        }

        /* --- UTILITIES --- */
        .hidden { display: none; }
        .flex-row { display: flex; gap: 10px; align-items: center; }
        [data-rating="missile"] { border-left: 4px solid var(--missile); }
        [data-rating="prestazione"] { border-left: 4px solid var(--prestazione); }
        [data-rating="normale"] { border-left: 4px solid var(--normale); }
        [data-rating="lento"] { border-left: 4px solid var(--lento); }
        [data-rating="osceno"] { border-left: 4px solid var(--osceno); }
    </style>
</head>
<body class="dark-theme">

    <header class="top-bar">
        <div class="flex-row">
            <h2 style="margin:0; color:var(--accent); letter-spacing:1px;">DMS TITAN <span style="font-size:12px; color:var(--text-dim)">v3.0.1</span></h2>
            <div class="pit-target-box">
                <label>Pit Target (min)</label>
                <input type="text" id="pit-target-input" value="38:00" onchange="updateVirtualCalculations()">
            </div>
            <div id="sync-status" style="font-size:11px; color:var(--success)">‚óè DATABASE LIVE</div>
        </div>

        <div class="flex-row" style="flex:1; justify-content:center; max-width: 600px;">
            <input type="text" id="apex-url" placeholder="Incolla l'URL Apex Live Feed qui..." style="flex:1;">
            <button class="btn btn-success" onclick="initApexConnection()" style="padding: 10px 20px;">CONNETTI APEX</button>
        </div>

        <div class="flex-row">
            <button class="btn btn-ghost" onclick="undo()" title="Annulla ultima azione">UNDO ‚Ü©</button>
            <button class="btn btn-ghost" onclick="exportFullCSV()">EXPORT CSV üìä</button>
            <button class="btn btn-ghost" onclick="toggleTheme()">‚òÄÔ∏è/üåô</button>
            <button class="btn btn-danger" onclick="resetEntireRace()" style="padding:10px;">RESET</button>
        </div>
    </header>

    <main class="main-grid">
        
        <section class="panel">
            <div class="telemetry-split">
                <div class="table-wrapper">
                    <table id="telemetry-table">
                        <thead>
                            <tr>
                                <th class="col-pos">P.</th>
                                <th class="col-cat">CAT</th>
                                <th class="col-kart">KART</th>
                                <th class="col-team" style="width:180px">TEAM</th>
                                <th class="col-vgap">VIRTUAL GAP</th>
                                <th>PIT TIME</th>
                                <th>PIT</th>
                                <th>DISTACCO</th>
                                <th>BEST</th>
                                <th>IN PISTA</th>
                                <th>STATUS</th>
                            </tr>
                        </thead>
                        <tbody id="telemetry-body">
                            </tbody>
                    </table>
                </div>
                <div class="chart-container">
                    <div style="font-size:11px; font-weight:bold; color:var(--accent); margin-bottom:10px; text-transform:uppercase;">Trend Virtual Gap (Diretti)</div>
                    <canvas id="virtualChart"></canvas>
                </div>
            </div>
        </section>

        <section class="panel">
            <div class="management-split">
                <div style="display:flex; flex-direction:column; overflow:hidden;">
                    <div class="panel-header">
                        <span style="font-size:12px; font-weight:bold;">GESTIONE CORSIA BOX / KART DEPOT</span>
                        <button class="btn btn-accent" style="padding:4px 10px; font-size:11px;" onclick="addNewLane()">+ NUOVA CORSIA</button>
                    </div>
                    <div id="lanes-render-area" class="lanes-container">
                        </div>
                </div>

                <div class="control-panel">
                    <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:8px; border:1px solid var(--border);">
                        <label style="font-size:11px; color:var(--text-dim); margin-bottom:8px; display:block;">SEARCH & ADD TEAM</label>
                        <div class="flex-row" style="margin-bottom:10px;">
                            <input type="text" id="quick-team-search" placeholder="Team # o Nome..." oninput="searchInDB()">
                        </div>
                        <div id="search-preview" style="min-height:20px; font-size:12px; font-weight:bold; color:var(--success);"></div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn btn-ghost" onclick="markAction('drop')">LASCIATO</button>
                        <button class="btn btn-ghost" onclick="markAction('take')">PRESO</button>
                    </div>

                    <div style="padding:10px; border:1px dashed var(--border); border-radius:8px;">
                        <label style="font-size:11px; color:var(--text-dim)">OUR KART ID</label>
                        <input type="text" id="our-kart-id" placeholder="Es. 22" style="margin-top:5px; border-color:var(--accent)" onchange="updateOurKart()">
                    </div>

                    <button id="main-pit-btn" class="btn btn-success" style="height:60px; font-size:18px; display:none;" onclick="finalizePitAction()">
                        CONFERMA PIT STOP
                    </button>
                </div>

                <div class="log-panel">
                    <div style="font-size:11px; font-weight:800; color:var(--text-dim); margin-bottom:10px;">LIVE RACE LOG</div>
                    <div id="action-logs">
                        </div>
                    <button class="btn btn-ghost" style="margin-top:10px; font-size:10px; padding:5px;" onclick="clearLogs()">Svuota Log</button>
                </div>
            </div>
        </section>
    </main>

    <div class="db-drawer" id="db-drawer">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">DATABASE ANAGRAFICA TEAM</h3>
            <div class="flex-row">
                <input type="text" id="new-team-name" placeholder="Nome Team" style="width:180px;">
                <input type="text" id="new-team-num" placeholder="#" style="width:60px;">
                <select id="new-team-cat" style="width:80px;">
                    <option value="EK1">EK1</option>
                    <option value="EK2">EK2</option>
                    <option value="EK3">EK3</option>
                </select>
                <button class="btn btn-success" style="padding:8px 15px;" onclick="addManualTeam()">+ AGGIUNGI</button>
            </div>
        </div>
        <table style="font-size:13px;">
            <thead>
                <tr>
                    <th>TEAM NAME</th>
                    <th># GARA</th>
                    <th>CAT</th>
                    <th>KART ATTUALE</th>
                    <th>PIT EFFETTUATI</th>
                    <th>TOTALE BOX</th>
                    <th>AZIONI</th>
                </tr>
            </thead>
            <tbody id="db-teams-body">
                </tbody>
        </table>
    </div>

<script>
    // ==========================================
    // CONFIGURAZIONE FIREBASE
    // ==========================================
    const firebaseConfig = { 
        apiKey: "AIzaSyDKhKjjrVb1EtNosBsO-5dYICBfLU8Feco", 
        databaseURL: "https://gestione-cambi-kart---dms-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "gestione-cambi-kart---dms"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ==========================================
    // STATO GLOBALE APPLICAZIONE
    // ==========================================
    let state = {
        lanes: [
            { id: 'lane_1', name: 'CORSIA A', karts: [] },
            { id: 'lane_2', name: 'CORSIA B', karts: [] }
        ],
        teams: [],
        logs: [],
        ourKart: "",
        telemetryHistory: [], // Per il grafico
        directCompetitors: [], // Team da monitorare sul grafico
        history: [] // Stack per Undo
    };

    let chartInstance = null;
    let apexInterval = null;
    let pendingAction = { type: null, teamIdx: null };

    // ==========================================
    // INIZIALIZZAZIONE & SYNC
    // ==========================================
    window.onload = () => {
        // Caricamento iniziale da Firebase
        database.ref('v3_titan_state').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // Merge intelligente per non rompere il grafico durante gli update
                state.lanes = data.lanes || [];
                state.teams = data.teams || [];
                state.logs = data.logs || [];
                state.ourKart = data.ourKart || "";
                state.directCompetitors = data.directCompetitors || [];
                
                renderAll();
            }
        });

        initChart();
        
        // Mock se DB vuoto
        if(state.teams.length === 0) {
            state.teams = [
                { name: "DMS RACING", num: "22", cat: "EK1", pitCount: 0, totalPitTime: "00:00", currentKart: "22" }
            ];
            save();
        }
    };

    // ==========================================
    // GESTIONE DATABASE & SALVATAGGIO
    // ==========================================
    function save() {
        database.ref('v3_titan_state').set({
            lanes: state.lanes,
            teams: state.teams,
            logs: state.logs,
            ourKart: state.ourKart,
            directCompetitors: state.directCompetitors
        });
    }

    function pushHistory() {
        // Snapshot per l'undo
        state.history.push(JSON.stringify({
            lanes: state.lanes,
            teams: state.teams,
            logs: state.logs,
            ourKart: state.ourKart
        }));
        if(state.history.length > 30) state.history.shift();
    }

    function undo() {
        if(state.history.length === 0) return alert("Nulla da annullare!");
        const last = JSON.parse(state.history.pop());
        state.lanes = last.lanes;
        state.teams = last.teams;
        state.logs = last.logs;
        state.ourKart = last.ourKart;
        save();
    }

    // ==========================================
    // ENGINE TELEMETRIA APEX
    // ==========================================
    function initApexConnection() {
        const url = document.getElementById('apex-url').value.trim();
        if(!url) return alert("Inserisci un URL Feed valido");
        
        if(apexInterval) clearInterval(apexInterval);
        
        // Simulo aggiornamento ogni 3 sec
        apexInterval = setInterval(() => {
            fetchApexData(url);
        }, 3000);
        
        addLog("Connessione Apex avviata.");
    }

    async function fetchApexData(url) {
        try {
            // Qui andrebbe la chiamata fetch reale tramite proxy (CORS bypass)
            // Per ora simuliamo i dati reali che arrivano da Apex
            const mockRaw = [
                { pos: 1, num: "1", team: "NAC TEAM", cat: "EK1", laps: 155, pit: 12, pitTime: "37:50", gap: "LEADER", last: "1:02.1", best: "1:01.8", track: "1:45" },
                { pos: 2, num: "22", team: "DMS RACING", cat: "EK1", laps: 155, pit: 11, pitTime: "39:05", gap: "+5.2", last: "1:02.5", best: "1:02.0", track: "5:12" },
                { pos: 3, num: "49", team: "SPARK", cat: "EK2", laps: 154, pit: 14, pitTime: "38:10", gap: "1 Giro", last: "1:03.4", best: "1:02.9", track: "IN PIT" },
                { pos: 4, num: "7", team: "KRT ALLEY", cat: "EK1", laps: 154, pit: 13, pitTime: "36:20", gap: "1 Giro", last: "1:02.9", best: "1:02.4", track: "2:30" }
            ];

            processTelemetry(mockRaw);
        } catch (err) {
            console.error("Errore fetch:", err);
        }
    }

    function processTelemetry(data) {
        const targetSec = parseTimeToSec(document.getElementById('pit-target-input').value);
        
        const processed = data.map(t => {
            const pitSec = parseTimeToSec(t.pitTime);
            // Deficit: Quanto tempo box deve ancora fare rispetto al target
            const deficit = Math.max(0, targetSec - pitSec);
            // Calcolo Virtual Gap (semplificato: gap reale in secondi + deficit)
            let realGapSec = 0;
            if(t.gap !== "LEADER") {
                if(t.gap.includes("Giro")) realGapSec = parseInt(t.gap) * 62; // 62s tempo medio giro
                else realGapSec = parseFloat(t.gap.replace('+', ''));
            }
            
            const vTotal = realGapSec + deficit;
            return { ...t, vGap: vTotal };
        });

        // Riordiniamo la classifica basandoci sul Virtual Gap
        processed.sort((a,b) => a.vGap - b.vGap);
        const leaderV = processed[0].vGap;

        const finalData = processed.map(t => ({
            ...t,
            vGapRel: (t.vGap - leaderV).toFixed(1)
        }));

        renderTelemetry(finalData);
        updateChartData(finalData);
    }

    function renderTelemetry(data) {
        const body = document.getElementById('telemetry-body');
        body.innerHTML = data.map((t, idx) => `
            <tr class="${t.num == state.ourKart ? 'row-us' : ''} ${t.track == 'IN PIT' ? 'row-pitting' : ''}">
                <td>${idx+1}</td>
                <td><span class="badge-cat ${t.cat.toLowerCase()}">${t.cat}</span></td>
                <td style="font-weight:900">#${t.num}</td>
                <td>${t.team}</td>
                <td class="col-vgap">+${t.vGapRel}s</td>
                <td>${t.pitTime}</td>
                <td>${t.pit}</td>
                <td style="color:var(--text-dim)">${t.gap}</td>
                <td style="color:var(--text-dim)">${t.best}</td>
                <td style="color:${t.track == 'IN PIT' ? 'var(--warning)' : 'inherit'}">${t.track}</td>
                <td>
                    <button class="btn btn-ghost" style="padding:2px 6px; font-size:9px;" onclick="toggleCompetitor('${t.num}')">
                        ${state.directCompetitors.includes(t.num) ? 'üìâ RIMUOVI' : 'üìà TRACCIA'}
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // ==========================================
    // GRAFICO TREND (CHART.JS)
    // ==========================================
    function initChart() {
        const ctx = document.getElementById('virtualChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                    y: { reverse: true, grid: { color: '#1a202a' }, ticks: { color: '#9ba3b1' } },
                    x: { grid: { display: false }, ticks: { display: false } }
                },
                plugins: { legend: { labels: { color: '#eceff4', boxWidth: 10, font: { size: 10 } } } }
            }
        });
    }

    function updateChartData(teleData) {
        const now = new Date().toLocaleTimeString();
        if(chartInstance.data.labels.length > 30) chartInstance.data.labels.shift();
        chartInstance.data.labels.push(now);

        state.directCompetitors.forEach(num => {
            const teamData = teleData.find(t => t.num == num);
            if(!teamData) return;

            let dataset = chartInstance.data.datasets.find(d => d.label === `Kart #${num}`);
            if(!dataset) {
                dataset = {
                    label: `Kart #${num}`,
                    data: [],
                    borderColor: num == state.ourKart ? '#1d8cf8' : getRandomColor(),
                    tension: 0.3,
                    borderWidth: 2,
                    pointRadius: 0
                };
                chartInstance.data.datasets.push(dataset);
            }
            if(dataset.data.length > 30) dataset.data.shift();
            dataset.data.push(teamData.vGapRel);
        });
        chartInstance.update();
    }

    function toggleCompetitor(num) {
        if(state.directCompetitors.includes(num)) {
            state.directCompetitors = state.directCompetitors.filter(n => n !== num);
            chartInstance.data.datasets = chartInstance.data.datasets.filter(d => d.label !== `Kart #${num}`);
        } else {
            state.directCompetitors.push(num);
        }
        save();
        chartInstance.update();
    }

    // ==========================================
    // GESTIONE CORSIE & DRAG-AND-DROP
    // ==========================================
    function renderLanes() {
        const container = document.getElementById('lanes-render-area');
        container.innerHTML = '';

        state.lanes.forEach(lane => {
            const laneEl = document.createElement('div');
            laneEl.className = 'lane';
            laneEl.innerHTML = `
                <div class="lane-head">
                    <span contenteditable="true" onblur="renameLane('${lane.id}', this.innerText)">${lane.name}</span>
                    <button onclick="removeLane('${lane.id}')" style="background:none; border:none; color:var(--warning); cursor:pointer;">√ó</button>
                </div>
                <div class="kart-list" id="list-${lane.id}" data-id="${lane.id}">
                    ${(lane.karts || []).map((k, idx) => `
                        <div class="kart-card" data-num="${k.num}" data-rating="${k.rating}">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-weight:900; font-size:16px;">#${k.num}</span>
                                <span style="font-size:9px; text-transform:uppercase; font-weight:bold; color:var(--${k.rating})">${k.rating}</span>
                            </div>
                            <div class="rating-dots">
                                <div class="dot" style="background:var(--missile)" onclick="updateRating('${lane.id}', ${idx}, 'missile')"></div>
                                <div class="dot" style="background:var(--prestazione)" onclick="updateRating('${lane.id}', ${idx}, 'prestazione')"></div>
                                <div class="dot" style="background:var(--normale)" onclick="updateRating('${lane.id}', ${idx}, 'normale')"></div>
                                <div class="dot" style="background:var(--lento)" onclick="updateRating('${lane.id}', ${idx}, 'lento')"></div>
                                <div class="dot" style="background:var(--osceno)" onclick="updateRating('${lane.id}', ${idx}, 'osceno')"></div>
                                <button onclick="removeKart('${lane.id}', ${idx})" style="margin-left:auto; border:none; background:none; color:var(--text-dim); cursor:pointer;">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="padding:10px; border-top:1px solid var(--border); display:flex; gap:5px;">
                    <input type="text" id="input-${lane.id}" placeholder="Kart #" style="font-size:12px; padding:5px;">
                    <button class="btn btn-success" style="padding:5px 10px;" onclick="quickAddKart('${lane.id}')">+</button>
                </div>
            `;
            container.appendChild(laneEl);
        });

        reinitSortables();
    }

    function reinitSortables() {
        state.lanes.forEach(lane => {
            const el = document.getElementById(`list-${lane.id}`);
            new Sortable(el, {
                group: 'shared-karts',
                animation: 150,
                onEnd: () => syncLanesFromDOM()
            });
        });
    }

    function syncLanesFromDOM() {
        pushHistory();
        state.lanes.forEach(lane => {
            const el = document.getElementById(`list-${lane.id}`);
            const cards = Array.from(el.querySelectorAll('.kart-card'));
            lane.karts = cards.map(c => ({
                num: c.dataset.num,
                rating: c.dataset.rating
            }));
        });
        save();
        addLog("Spostamento kart registrato.");
    }

    function addNewLane() {
        pushHistory();
        const id = 'lane_' + Date.now();
        state.lanes.push({ id, name: 'NUOVA CORSIA', karts: [] });
        save();
    }

    function removeLane(id) {
        if(!confirm("Eliminare questa corsia e i kart contenuti?")) return;
        pushHistory();
        state.lanes = state.lanes.filter(l => l.id !== id);
        save();
    }

    function quickAddKart(laneId) {
        const input = document.getElementById(`input-${laneId}`);
        if(!input.value) return;
        pushHistory();
        const lane = state.lanes.find(l => l.id === laneId);
        lane.karts.push({ num: input.value, rating: 'normale' });
        input.value = '';
        save();
        addLog(`Kart #${input.value} aggiunto a ${lane.name}`);
    }

    function updateRating(laneId, idx, rating) {
        pushHistory();
        state.lanes.find(l => l.id === laneId).karts[idx].rating = rating;
        save();
        addLog(`Kart #${state.lanes.find(l => l.id === laneId).karts[idx].num} aggiornato a ${rating}`);
    }

    function removeKart(laneId, idx) {
        pushHistory();
        state.lanes.find(l => l.id === laneId).karts.splice(idx, 1);
        save();
    }

    // ==========================================
    // AZIONI PIT STOP
    // ==========================================
    function searchInDB() {
        const query = document.getElementById('quick-team-search').value.toLowerCase();
        const resDiv = document.getElementById('search-preview');
        if(!query) { resDiv.innerText = ""; pendingAction.teamIdx = null; return; }

        const idx = state.teams.findIndex(t => t.num === query || t.name.toLowerCase().includes(query));
        if(idx !== -1) {
            const t = state.teams[idx];
            resDiv.innerText = `PRONTO: ${t.name} (Kart: ${t.currentKart})`;
            resDiv.style.color = "var(--success)";
            pendingAction.teamIdx = idx;
        } else {
            resDiv.innerText = "TEAM NON IN DB";
            resDiv.style.color = "var(--warning)";
            pendingAction.teamIdx = null;
        }
    }

    function markAction(type) {
        if(pendingAction.teamIdx === null) return alert("Cerca prima un team valido nel database!");
        pendingAction.type = type;
        document.getElementById('main-pit-btn').innerText = `CONFERMA ${type.toUpperCase()} (#${state.teams[pendingAction.teamIdx].num})`;
        document.getElementById('main-pit-btn').style.display = "block";
    }

    function finalizePitAction() {
        pushHistory();
        const team = state.teams[pendingAction.teamIdx];
        const now = new Date().toLocaleTimeString();
        
        if(pendingAction.type === 'drop') {
            team.pitCount++;
            addLog(`PIT: ${team.name} ha LASCIATO il kart ${team.currentKart}`);
        } else {
            addLog(`PIT: ${team.name} ha PRESO il kart ${team.currentKart}`);
        }

        document.getElementById('main-pit-btn').style.display = "none";
        document.getElementById('quick-team-search').value = "";
        document.getElementById('search-preview').innerText = "";
        save();
    }

    // ==========================================
    // LOGICA DB & UTILS
    // ==========================================
    function renderDB() {
        const body = document.getElementById('db-teams-body');
        body.innerHTML = state.teams.map((t, idx) => `
            <tr>
                <td>${t.name}</td>
                <td><span style="font-weight:900">#${t.num}</span></td>
                <td><span class="badge-cat ${t.cat.toLowerCase()}">${t.cat}</span></td>
                <td>#${t.currentKart}</td>
                <td>${t.pitCount}</td>
                <td>${t.totalPitTime}</td>
                <td>
                    <button class="btn btn-ghost" style="padding:4px;" onclick="deleteTeam(${idx})">üóëÔ∏è</button>
                </td>
            </tr>
        `).join('');
    }

    function addManualTeam() {
        const name = document.getElementById('new-team-name').value;
        const num = document.getElementById('new-team-num').value;
        const cat = document.getElementById('new-team-cat').value;
        if(!name || !num) return;
        
        pushHistory();
        state.teams.push({
            name: name, num: num, cat: cat,
            pitCount: 0, totalPitTime: "00:00", currentKart: num
        });
        
        document.getElementById('new-team-name').value = '';
        document.getElementById('new-team-num').value = '';
        save();
    }

    function deleteTeam(idx) {
        if(!confirm("Eliminare team dal database?")) return;
        pushHistory();
        state.teams.splice(idx, 1);
        save();
    }

    function addLog(msg) {
        const now = new Date().toLocaleTimeString();
        state.logs.push({ ts: now, txt: msg });
        if(state.logs.length > 100) state.logs.shift();
        renderLogs();
    }

    function renderLogs() {
        const div = document.getElementById('action-logs');
        div.innerHTML = state.logs.map(l => `
            <div class="log-line"><span style="color:var(--accent)">[${l.ts}]</span> ${l.txt}</div>
        `).join('');
    }

    function parseTimeToSec(str) {
        if(!str || typeof str !== 'string') return 0;
        const parts = str.split(':').reverse();
        let sec = 0;
        if(parts[0]) sec += parseFloat(parts[0]); // Secondi
        if(parts[1]) sec += parseInt(parts[1]) * 60; // Minuti
        if(parts[2]) sec += parseInt(parts[2]) * 3600; // Ore
        return sec;
    }

    function getRandomColor() {
        const colors = ['#fd5d93', '#00f2c3', '#ff8d72', '#1d8cf8', '#ffdf00', '#e74c3c'];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    function exportFullCSV() {
        let csv = "REPORT GARA DMS TITAN\n";
        csv += "TIMESTAMP;EVENTO\n";
        state.logs.forEach(l => csv += `${l.ts};${l.txt}\n`);
        
        csv += "\nSTATO DATABASE TEAM\n";
        csv += "TEAM;NUM;CAT;KART;PIT_COUNT;TOT_BOX\n";
        state.teams.forEach(t => csv += `${t.name};${t.num};${t.cat};${t.currentKart};${t.pitCount};${t.totalPitTime}\n`);

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `DMS_Titan_Export_${Date.now()}.csv`;
        a.click();
    }

    function toggleTheme() {
        document.body.classList.toggle('light-theme');
    }

    function resetEntireRace() {
        if(!confirm("ATTENZIONE: Questo canceller√† TUTTI i dati della gara (corsie, log, storico grafico). Procedere?")) return;
        state.logs = [];
        state.history = [];
        state.lanes.forEach(l => l.karts = []);
        state.directCompetitors = [];
        chartInstance.data.labels = [];
        chartInstance.data.datasets = [];
        chartInstance.update();
        save();
        location.reload();
    }

    function renderAll() {
        renderLanes();
        renderDB();
        renderLogs();
        document.getElementById('our-kart-id').value = state.ourKart;
    }

    function updateOurKart() {
        state.ourKart = document.getElementById('our-kart-id').value;
        save();
    }

</script>
</body>
</html>
