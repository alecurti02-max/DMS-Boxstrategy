<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DMS STRATEGY V3.0 - ALL-IN-ONE SYSTEM</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Palette Dark (Default) */
            --bg: #0b0e14; --card: #151921; --header: #1d2331;
            --text: #e9ecef; --text-dim: #888;
            --accent: #1d8cf8; --success: #00f2c3; --warning: #ff4757;
            --border: #2b3548; --pit-row: rgba(0, 242, 195, 0.05);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.light-theme {
            --bg: #f4f7f6; --card: #ffffff; --header: #ebf0f1;
            --text: #2d3436; --text-dim: #636e72;
            --border: #dfe6e9;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { 
            background-color: var(--bg); color: var(--text); 
            margin: 0; overflow: hidden; height: 100vh;
            transition: var(--transition);
        }

        /* LAYOUT STRUTTURALE */
        .app-grid {
            display: grid;
            grid-template-rows: 60px 1fr 1fr; /* Header | Telemetria | Box Management */
            height: 100vh; gap: 5px; padding: 5px;
        }

        .panel { 
            background: var(--card); border: 1px solid var(--border); 
            border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* HEADER */
        .main-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; background: var(--header); border-radius: 8px;
        }

        /* TELEMETRIA (TOP PANEL) */
        .telemetry-table-wrapper { flex: 1; overflow: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; table-layout: fixed; }
        th { 
            background: var(--header); color: var(--text-dim); position: sticky; top: 0; 
            padding: 10px; text-align: left; font-size: 0.75em; text-transform: uppercase;
            border-bottom: 2px solid var(--border); z-index: 10;
        }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); font-weight: 600; }
        
        .col-pos { width: 40px; } .col-kart { width: 60px; } .col-team { width: 180px; }
        .col-vgap { width: 100px; color: var(--success); font-weight: 800; font-size: 1.1em; }
        
        .row-us { background: rgba(0, 242, 195, 0.1) !important; color: var(--success); }
        .row-pitting { animation: pulse-pit 2s infinite; background: rgba(255, 71, 87, 0.1); }
        @keyframes pulse-pit { 50% { background: rgba(255, 71, 87, 0.2); } }

        /* GESTIONE CAMBI (BOTTOM PANEL) */
        .management-grid {
            display: grid; grid-template-columns: 1fr 350px 300px; /* Corsie | Controlli | Log */
            gap: 10px; height: 100%; padding: 10px;
        }

        /* N-CORSIE DINAMICHE */
        .lanes-scroll { 
            display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; 
            scrollbar-width: thin;
        }
        .lane {
            min-width: 200px; background: rgba(0,0,0,0.2); border-radius: 6px;
            display: flex; flex-direction: column; border-top: 4px solid var(--accent);
        }
        .lane-header { padding: 8px; font-weight: bold; font-size: 0.8em; display: flex; justify-content: space-between; }
        .kart-list { flex: 1; min-height: 100px; padding: 5px; }
        
        .kart-item {
            background: var(--card); padding: 12px; margin-bottom: 8px; border-radius: 6px;
            border: 1px solid var(--border); display: flex; justify-content: space-between;
            cursor: grab; transition: var(--transition);
        }
        .kart-item:active { cursor: grabbing; }

        /* BADGES */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7em; font-weight: 900; }
        .b-missile { background: #ffdf00; color: #000; }
        .b-prestazione { background: #00f2c3; color: #000; }
        .b-normale { background: #34495e; color: #fff; }

        /* PIT BRIDGE NOTIFICATION */
        #pit-bridge {
            position: absolute; top: 70px; right: 20px; width: 300px;
            background: var(--warning); color: white; padding: 15px;
            border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; z-index: 1000; transform: translateX(400px);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #pit-bridge.active { display: block; transform: translateX(0); }

        /* CONTROLLI */
        .btn { 
            padding: 10px 15px; border: none; border-radius: 5px; font-weight: bold; 
            cursor: pointer; transition: opacity 0.2s;
        }
        .btn-success { background: var(--success); color: #000; }
        .btn-accent { background: var(--accent); color: #fff; }
        .btn-danger { background: var(--warning); color: #fff; }

        input, select { 
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            padding: 8px; border-radius: 4px;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .management-grid { grid-template-columns: 1fr; grid-template-rows: auto auto auto; overflow-y: auto; }
            .app-grid { grid-template-rows: 60px 1.2fr 2fr; }
        }
    </style>
</head>
<body class="dark-theme">

<div id="pit-bridge">
    <div style="font-weight: 900; margin-bottom: 5px;">‚ö†Ô∏è PIT DETECTED!</div>
    <div id="pit-bridge-msg" style="font-size: 0.9em; margin-bottom: 10px;"></div>
    <div style="display:flex; gap:5px;">
        <button class="btn btn-success" onclick="quickAction('change')" style="flex:1">CAMBIO KART</button>
        <button class="btn" onclick="quickAction('ignore')" style="background:rgba(255,255,255,0.2); flex:1">IGNORA</button>
    </div>
</div>

<div class="app-grid">
    
    <header class="main-header">
        <div style="display:flex; align-items:center; gap:20px;">
            <h2 style="margin:0; color:var(--accent); letter-spacing:1px;">DMS V3.0</h2>
            <div id="sync-status" style="font-size:0.7em; color:var(--success)">‚óè DATABASE LIVE</div>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <input type="text" id="apexUrl" placeholder="Apex URL..." style="width:250px;">
            <button class="btn btn-success" onclick="connectApex()">CONNECT</button>
            <div style="height:20px; width:1px; background:var(--border);"></div>
            <button class="btn" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è</button>
            <button class="btn btn-danger" onclick="resetSystem()">RESET</button>
        </div>
    </header>

    <section class="panel">
        <div class="telemetry-table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th class="col-pos">Cla</th>
                        <th class="col-kart">Kart</th>
                        <th class="col-team">Team</th>
                        <th>Giri</th>
                        <th style="color:var(--accent)">V-Gap</th>
                        <th>Tempo Pit</th>
                        <th>Ultimo</th>
                        <th>Distacco</th>
                        <th>Best</th>
                        <th>In Pista</th>
                        <th>Pit</th>
                    </tr>
                </thead>
                <tbody id="telemetry-body">
                    </tbody>
            </table>
        </div>
    </section>

    <section class="panel">
        <div class="management-grid">
            
            <div style="display:flex; flex-direction:column; overflow:hidden;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <strong style="font-size:0.8em; color:var(--text-dim)">KART NEI BOX</strong>
                    <button class="btn btn-accent" style="padding:2px 8px; font-size:0.7em;" onclick="addNewLane()">+ AGGIUNGI CORSIA</button>
                </div>
                <div id="lanes-container" class="lanes-scroll">
                    </div>
            </div>

            <div style="border-left:1px solid var(--border); padding-left:15px; display:flex; flex-direction:column; gap:10px;">
                <strong style="font-size:0.8em; color:var(--text-dim)">CONTROLLO MOVIMENTO</strong>
                <div style="background:var(--bg); padding:10px; border-radius:8px;">
                    <input type="text" id="pit-team-input" placeholder="Team Entrante (# o Nome)" style="width:100%; margin-bottom:10px;" oninput="syncTeamInfo()">
                    <div id="pit-team-info" style="min-height:20px; font-weight:bold; color:var(--success); font-size:0.9em;"></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                    <button class="btn" style="background:#2c2c44;" onclick="prepMove('drop', 'L1')">LASCIATO</button>
                    <button class="btn" style="background:#2c2c44;" onclick="prepMove('take', 'L1')">PRESO</button>
                </div>
                <button class="btn btn-success" id="confirm-pit-btn" style="margin-top:auto; height:60px; font-size:1.2em; display:none;" onclick="finalizePit()">CONFERMA PIT</button>
            </div>

            <div style="border-left:1px solid var(--border); padding-left:15px; display:flex; flex-direction:column;">
                <strong style="font-size:0.8em; color:var(--text-dim)">LOG ATTIVIT√Ä</strong>
                <div id="action-log" style="flex:1; overflow-y:auto; font-size:0.75em; color:var(--text-dim); margin-top:10px;">
                    </div>
                <button class="btn btn-danger" style="margin-top:10px; font-size:0.7em;" onclick="undo()">ANNULLA ULTIMA</button>
            </div>

        </div>
    </section>

</div>

<script>
    // --- CONFIGURAZIONE E STATO ---
    const firebaseConfig = { 
        apiKey: "AIzaSyDKhKjjrVb1EtNosBsO-5dYICBfLU8Feco", 
        databaseURL: "https://gestione-cambi-kart---dms-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "gestione-cambi-kart---dms" 
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let state = {
        lanes: [
            { id: 'L1', name: 'CORSIA 1', karts: [] },
            { id: 'L2', name: 'CORSIA 2', karts: [] }
        ],
        teams: [],
        log: [],
        history: [],
        ourKartId: "",
        targetPitSeconds: 2280 // Default 38:00
    };

    let sortableInstances = [];
    let apexInterval = null;
    let pendingPit = { teamIdx: null, dropLane: null, takeLane: null };

    // --- INIZIALIZZAZIONE ---
    window.onload = () => {
        database.ref('v3_raceState').on('value', (snap) => {
            const data = snap.val();
            if (data) {
                state = data;
                renderAll();
            }
        });
        loadLocalSettings();
    };

    // --- LOGICA RENDERING ---
    function renderAll() {
        renderLanes();
        renderTelemetry([]); // Verr√† popolato da Apex
        renderLogs();
    }

    function renderLanes() {
        const container = document.getElementById('lanes-container');
        container.innerHTML = '';

        state.lanes.forEach(lane => {
            const laneEl = document.createElement('div');
            laneEl.className = 'lane';
            laneEl.innerHTML = `
                <div class="lane-header">
                    <span>${lane.name}</span>
                    <button onclick="removeLane('${lane.id}')" style="background:none; border:none; color:var(--warning); cursor:pointer;">√ó</button>
                </div>
                <div class="kart-list" id="list-${lane.id}" data-id="${lane.id}">
                    ${(lane.karts || []).map((k, idx) => `
                        <div class="kart-item" data-num="${k.num}" data-rating="${k.rating}">
                            <span style="font-weight:900;">#${k.num}</span>
                            <span class="badge b-${k.rating}">${k.rating.charAt(0)}</span>
                        </div>
                    `).join('')}
                </div>
                <div style="padding:5px; display:flex; gap:2px;">
                    <input type="number" id="in-${lane.id}" placeholder="#" style="width:60px; font-size:0.7em;">
                    <button class="btn btn-success" style="padding:2px 10px;" onclick="addKartDirect('${lane.id}')">+</button>
                </div>
            `;
            container.appendChild(laneEl);
        });

        initSortables();
    }

    function initSortables() {
        sortableInstances.forEach(i => i.destroy());
        sortableInstances = [];

        state.lanes.forEach(lane => {
            const el = document.getElementById(`list-${lane.id}`);
            sortableInstances.push(new Sortable(el, {
                group: 'lanes',
                animation: 150,
                onEnd: (evt) => {
                    updateStateFromDOM();
                }
            }));
        });
    }

    // --- LOGICA TELEMETRIA APEX ---
    async function connectApex() {
        const url = document.getElementById('apexUrl').value;
        if (!url) return;
        
        if (apexInterval) clearInterval(apexInterval);
        
        // Simulazione fetch ogni 3 secondi (In produzione usa fetch reale col proxy)
        apexInterval = setInterval(async () => {
            // Qui andrebbe il fetch al proxy
            const mockData = generateMockData(); 
            processTelemetry(mockData);
        }, 3000);
    }

    function processTelemetry(data) {
        // Calcolo Virtual Gap
        const processed = data.map(t => {
            const pitSec = parseTime(t.tempoPit);
            const deficit = Math.max(0, state.targetPitSeconds - pitSec);
            return { ...t, vTotal: parseTime(t.tempo) + deficit };
        });

        processed.sort((a,b) => a.vTotal - b.vTotal);
        const leaderV = processed[0].vTotal;
        
        const finalData = processed.map(t => ({
            ...t,
            vGap: (t.vTotal - leaderV).toFixed(1)
        }));

        renderTelemetry(finalData);
        checkPitBridge(finalData);
    }

    function renderTelemetry(data) {
        const body = document.getElementById('telemetry-body');
        body.innerHTML = data.map((row, idx) => `
            <tr class="${row.num == state.ourKartId ? 'row-us' : ''} ${row.inPista == 'IN PIT' ? 'row-pitting' : ''}">
                <td>${idx+1}</td>
                <td style="font-weight:900">#${row.num}</td>
                <td style="font-size:0.9em; white-space:nowrap; overflow:hidden;">${row.team}</td>
                <td>${row.giri}</td>
                <td class="col-vgap">+${row.vGap}s</td>
                <td>${row.tempoPit}</td>
                <td style="font-family:monospace">${row.ultimo}</td>
                <td>${row.distacco}</td>
                <td style="color:var(--text-dim)">${row.best}</td>
                <td style="font-size:0.8em; color:${row.inPista == 'IN PIT' ? 'var(--warning)' : 'inherit'}">${row.inPista}</td>
                <td>${row.pitCount}</td>
            </tr>
        `).join('');
    }

    // --- PIT BRIDGE (AUTOMAZIONE) ---
    function checkPitBridge(data) {
        const pitting = data.find(t => t.inPista === 'IN PIT' && t.num != state.ourKartId); // Esempio: rileva altri
        const bridge = document.getElementById('pit-bridge');
        
        if (pitting) {
            document.getElementById('pit-bridge-msg').innerText = `${pitting.team} (#${pitting.num}) √® entrato ai box!`;
            bridge.classList.add('active');
            // Auto-fill input
            document.getElementById('pit-team-input').value = pitting.num;
            syncTeamInfo();
        } else {
            bridge.classList.remove('active');
        }
    }

    // --- AZIONI CORE ---
    function addNewLane() {
        const newId = 'L' + (state.lanes.length + 1);
        state.lanes.push({ id: newId, name: 'CORSIA ' + (state.lanes.length + 1), karts: [] });
        save();
    }

    function addKartDirect(laneId) {
        const input = document.getElementById(`in-${laneId}`);
        if (!input.value) return;
        const lane = state.lanes.find(l => l.id === laneId);
        lane.karts.push({ num: input.value, rating: 'normale' });
        input.value = '';
        save();
    }

    function finalizePit() {
        const teamInput = document.getElementById('pit-team-input').value;
        const logMsg = `PIT: Team ${teamInput} ha effettuato sosta.`;
        
        state.log.push({ ts: new Date().toLocaleTimeString(), txt: logMsg });
        // Logica cambio kart automatizzata...
        
        document.getElementById('pit-team-input').value = '';
        document.getElementById('confirm-pit-btn').style.display = 'none';
        save();
    }

    // --- UTILS ---
    function save() {
        database.ref('v3_raceState').set(state);
    }

    function updateStateFromDOM() {
        state.lanes.forEach(lane => {
            const el = document.getElementById(`list-${lane.id}`);
            const items = Array.from(el.querySelectorAll('.kart-item'));
            lane.karts = items.map(item => ({
                num: item.dataset.num,
                rating: item.dataset.rating
            }));
        });
        save();
    }

    function parseTime(str) {
        if (!str || str.includes('Giri')) return 0;
        const parts = str.split(':').reverse();
        let sec = 0;
        if (parts[0]) sec += parseFloat(parts[0]);
        if (parts[1]) sec += parseInt(parts[1]) * 60;
        if (parts[2]) sec += parseInt(parts[2]) * 3600;
        return sec;
    }

    function toggleTheme() {
        document.body.classList.toggle('light-theme');
        const isLight = document.body.classList.contains('light-theme');
        document.getElementById('themeBtn').innerText = isLight ? "üåô" : "‚òÄÔ∏è";
    }

    function generateMockData() {
        // Funzione per test senza Apex Live
        return [
            { num: "22", team: "DMS RACING", giri: 526, tempo: "10:00:15", tempoPit: "38:02", ultimo: "1:02.8", distacco: "LEADER", best: "1:02.1", inPista: "0:45", pitCount: 12 },
            { num: "1", team: "NAC TEAM", giri: 526, tempo: "10:00:20", tempoPit: "38:01", ultimo: "1:03.1", distacco: "+5.2", best: "1:02.7", inPista: "IN PIT", pitCount: 14 }
        ];
    }

    function renderLogs() {
        const container = document.getElementById('action-log');
        container.innerHTML = state.log.slice().reverse().map(l => `
            <div style="margin-bottom:4px; border-bottom:1px solid rgba(255,255,255,0.05)">
                <span style="color:var(--accent)">[${l.ts}]</span> ${l.txt}
            </div>
        `).join('');
    }
</script>

</body>
</html>
